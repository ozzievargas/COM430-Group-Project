function devLogAdd(b){$("#devLog").append($("<div />",{text:b}))}function devLogSet(b){$("#devLog").html($("<div />",{text:b}))}var incrementKey=function(b,d){d in b?b[d]++:b[d]=1},highQualityInkIfAvailable=!1,implicitlyExpanding=!1,showGrid=!1,expansion=100,commandMode=!0;
function unregisterPositionHandlers(b){$.each("pointerdown pointermove pointerup pointerout pointerleave pointercancel mouseup mousemove mousedown touchstart touchmove touchend touchcancelled mouseout touchleave gesturechange gesturestart".split(" "),function(d,g){b.unbind(g)});WorkQueue.gracefullyResume()}
function progress(){var b=$("<div />").css({display:"inline-block",position:"relative",width:px(120),height:px(12),"background-color":"gray"}),d=$("<span />").css({position:"absolute",width:0,top:0,left:0,height:"100%","background-color":"green"}).appendTo(b),g=$("<progress />");g.append(b);var n=1,c=0,r=function(){d.css("width",sprintf("%s%%",Math.floor(c/n*100)));g.attr({value:c,max:n})},e={element:g,value:function(b){c=b;r();return e},max:function(c){n=c;r();return e}};return e}
function proportion(b,d){return b/d/(boardWidth/boardHeight)}function scaleScreenToWorld(b){var d;d=1<proportion(boardWidth,boardHeight)?viewboxWidth/boardWidth:viewboxHeight/boardHeight;return b*d}function scaleWorldToScreen(b){var d;d=1<proportion(boardWidth,boardHeight)?viewboxWidth/boardWidth:viewboxHeight/boardHeight;return b/d}function screenToWorld(b,d){var g=scaleScreenToWorld(b)+viewboxX,n=scaleScreenToWorld(d)+viewboxY;return{x:g,y:n}}
function worldToScreen(b,d){var g=scaleWorldToScreen(b-viewboxX),n=scaleWorldToScreen(d-viewboxY);return{x:g,y:n}}function detectPointerEvents(){try{return"pointerEnabled"in Navigator&&1==Navigator.pointerEnabled||void 0!=PointerEvent}catch(b){return!1}}
function registerPositionHandlers(b,d,g,n){var c=!1,r=function(c,b){var e=[c.x-10,c.y-10,c.x+10,c.y+10],d=!0;_.each(Modes.canvasInteractables,function(a,l){_.each(a,function(a){void 0!=a&&b in a&&(a.activated||intersectRect(e,a.getBounds()))&&(d=d&&a[b](c))})});return d},e=function(c,b){return{shift:c.shiftKey,ctrl:c.ctrlKey,alt:c.altKey,eraser:b}};$.each(b,function(b,B){var k=$(B);k.css({"touch-action":"none"});var h=!1,a={},l=function(f){return void 0!==f&&"touch"==f.originalEvent.pointerType?1<
_.size(a):!1},p=function(f){var x=f.originalEvent.pointerId,c="pen"==f.originalEvent.pointerType&&5==f.originalEvent.button,C=k.offset(),b=f.pageX-C.left,C=f.pageY-C.top,p=f.originalEvent.pressure||.5,t=screenToWorld(b,C),d=a[x]||{pointerId:x,pointerType:f.originalEvent.pointerType,eraser:c,points:[]};d.points.push({x:t.x,y:t.y,screenX:b,screenY:C,z:p});d.eraser=d.eraser||c;"touch"==f.originalEvent.pointerType&&(a[x]=d);l(f)&&(0==h&&_.each(a,function(f){f.points=[_.last(f.points)]}),h=!0);return{pointerType:f.pointerType,
eraser:d.eraser,x:b,y:C,z:p,worldPos:t}},E=function(f){var x=f.originalEvent.pointerId,N="pen"==f.originalEvent.pointerType&&5==f.originalEvent.button,C=k.offset(),b=f.pageX-C.left,C=f.pageY-C.top,l=f.originalEvent.pressure||.5,p=screenToWorld(b,C);"touch"==f.originalEvent.pointerType&&delete a[x];h&&0==_.size(a)&&(c=h=!1);return{pointerType:f.pointerType,eraser:N,x:b,y:C,z:l,worldPos:p}};if(detectPointerEvents()){var t=function(){takeControlOfViewbox(!0);var f=_.map(_.filter(a,function(f){return 0<
_.size(f.points)}),function(f){var a=_.first(f.points);f=_.last(f.points);return[a,f]});a={};var x=_.meanBy(f,function(f){return f[0].x-f[1].x}),c=_.meanBy(f,function(f){return f[0].y-f[1].y});Pan.translate(scaleWorldToScreen(x),scaleWorldToScreen(c));var x=_.min(_.map(f,function(f){return f[0].y})),b=_.max(_.map(f,function(f){return f[0].y})),c=_.min(_.map(f,function(f){return f[0].x})),l=_.max(_.map(f,function(f){return f[0].x})),x=b-x,c=l-c,l=_.min(_.map(f,function(f){return f[1].y})),b=_.max(_.map(f,
function(f){return f[1].y})),p=_.min(_.map(f,function(f){return f[1].x})),f=(_.max(_.map(f,function(f){return f[1].x}))-p+(b-l))/2;Zoom.scale((c+x)/2/f)};k.bind("pointerdown",function(f){f.originalEvent.pointerType!=f.POINTER_TYPE_TOUCH&&"touch"!=f.originalEvent.pointerType||!l(f)||(h=!0);var a=p(f);f.preventDefault();WorkQueue.pause();l(f)||h||(c=!0,r(a.worldPos,"down")&&d(a.x,a.y,a.z,a.worldPos,e(f,a.eraser)))});k.bind("pointermove",function(f){var a=p(f);f.preventDefault();f.originalEvent.pointerType!=
f.POINTER_TYPE_TOUCH&&"touch"!=f.originalEvent.pointerType||!l(f)&&!h?r(a.worldPos,"move")&&c&&g(a.x,a.y,a.z,a.worldPos,e(f,a.eraser)):t()});k.bind("pointerup",function(f){var a=E(f);WorkQueue.gracefullyResume();f.preventDefault();r(a.worldPos,"up")&&c&&!h&&n(a.x,a.y,a.z,a.worldPos,e(f,a.eraser));c=!1;Modes.finishInteractableStates()});var y=function(f){E(f);WorkQueue.gracefullyResume();f.preventDefault();if(c){var x=f.offsetX,b=f.offsetY,l=E(f);a={};WorkQueue.gracefullyResume();x=screenToWorld(x,
b);b=x.x;b<viewboxX?(takeControlOfViewbox(!0),Extend.left()):b>=viewboxX+viewboxWidth?(takeControlOfViewbox(!0),Extend.right()):r(x,"up")&&c&&!h&&n(l.x,l.y,l.z,l.worldPos,e(f,l.eraser));c=!1;Modes.finishInteractableStates()}c=!1;Modes.finishInteractableStates()};k.bind("pointerout",y);k.bind("pointerleave",y);k.bind("pointercancel",y)}else{k.bind("mousedown",function(f){WorkQueue.pause();var a=k.offset();c=!0;var b=f.pageX-a.left,a=f.pageY-a.top,l=screenToWorld(b,a);r(l,"down")&&d(b,a,.5,l,e(f));
f.preventDefault()});k.bind("mousemove",function(f){var a=k.offset();f.preventDefault();var b=f.pageX-a.left,a=f.pageY-a.top,l=screenToWorld(b,a);r(l,"move")&&c&&g(b,a,.5,l,e(f))});k.bind("mouseup",function(f){WorkQueue.gracefullyResume();f.preventDefault();var a=k.offset(),b=f.pageX-a.left,a=f.pageY-a.top,l=screenToWorld(b,a);r(l,"up")&&c&&n(b,a,.5,l,e(f));c=!1;Modes.finishInteractableStates()});var w=function(f,a,b){WorkQueue.gracefullyResume();var l=screenToWorld(f,a),p=l.x;p<viewboxX?(takeControlOfViewbox(!0),
Extend.left()):p>=viewboxX+viewboxWidth?(takeControlOfViewbox(!0),Extend.right()):r(l,"up")&&c&&!h&&n(f,a,.5,l,e(b,!1));c=!1};k.bind("mouseout",function(f){WorkQueue.gracefullyResume();f.preventDefault();c&&w(f.offsetX,f.offsetY,f);c=!1;Modes.finishInteractableStates()});var z,v=function(f){return{x:average(_.map(f,"x")),y:average(_.map(f,"y"))}},A=function(f){var a=[],c=k.offset();$.each(f,function(f,b){a.push({x:b.pageX-c.left,y:b.pageY-c.top,identifier:b.identifier})});return a};k.bind("touchstart",
function(f){WorkQueue.pause();f.preventDefault();var a=A(f.originalEvent.touches);if(1==a.length){var a=a[0],b=screenToWorld(a.x,a.y);c=!0;r(b,"down")&&d(a.x,a.y,.5,b,e(f))}else z=v(a)});k.bind("touchmove",function(f){f.preventDefault();var a=A(f.originalEvent.touches);switch(a.length){case 0:break;case 1:var a=a[0],b=screenToWorld(a.x,a.y);r(b,"move")&&c&&g(a.x,a.y,.5,b,e(f));break;default:f=v(a),a=f.x-z.x,b=f.y-z.y,z=f,takeControlOfViewbox(!0),Pan.translate(-1*a,-1*b)}});k.bind("touchend",function(f){WorkQueue.gracefullyResume();
f.preventDefault();var a=k.offset(),b=f.originalEvent.changedTouches[0],l=b.pageX-a.left,a=b.pageY-a.top,b=screenToWorld(l,a);r(b,"up")&&c&&(0>l||0>a||l>boardWidth||a>boardHeight?w(l,a):n(l,a,.5,b,e(f)));c=!1;Modes.finishInteractableStates()});var u=1;k.bind("gesturechange",function(f){WorkQueue.pause();f.preventDefault();c=!1;f=f.originalEvent.scale;takeControlOfViewbox(!0);Zoom.scale(u/f);u=f});k.bind("gestureend",function(){WorkQueue.gracefullyResume();u=1})}});return function(b){c=b}}
function aspectConstrainedDimensions(b,d){var g=boardHeight/boardWidth,n={height:d,width:b};d/b>g?n.height=b*g:n.width=d/g;return n}
function aspectConstrainedRect(b,d,g){var n=boardHeight/boardWidth,c={left:b.left,top:b.top,right:b.right,bottom:b.bottom,width:b.width,height:b.height};b.height/b.width>n?(c.height=b.width*n,g&&(d=b.height-c.height,"center"==g?c.top+=d/2:"bottom"==g&&(c.top+=d))):(c.width=b.height/n,d&&(g=b.width-c.width,"center"==d?c.left+=g/2:"right"==d&&(c.left+=g)));c.right=c.left+c.width;c.bottom=c.top+c.height;return c}
function copyBuffer(b){var d=document.createElement("canvas");d.width=b.width;d.height=b.height;d.getContext("2d").drawImage(b,0,0,b.width,b.height,0,0,b.width,b.height);return d}function intersectRect(b,d){return"undefined"!=typeof b&&"undefined"!=typeof d?!(d[0]>b[2]||d[2]<b[0]||d[1]>b[3]||d[3]<b[1]):!1}function overlapRect(b,d){return intersectRect(b,d)?(Math.max(b[0],d[0])-Math.min(b[2],d[2]))*(Math.max(b[1],d[1])-Math.min(b[3],d[3])):0}
function rectFromTwoPoints(b,d,g){g=g||0;var n,c,r;b.x<d.x?(n=b.x,r=d.x):(n=d.x,r=b.x);b.y<d.y?(c=b.y,b=d.y):(c=d.y,b=b.y);d=r-n;var e=b-c;d<g&&(r+=g-d,d=r-n);e<g&&(b+=g-e,e=b-c);return{left:n,top:c,right:r,bottom:b,width:d,height:e}}function updateMarquee(b,d,g){d=rectFromTwoPoints(d,g);g=$("#selectionAdorner");jQuery.contains(g,b)||g.append(b);b.is(":visible")||b.show();b.css({left:px(d.left),top:px(d.top),width:px(d.width),height:px(d.height)})}
function clampToView(b){var d=b.x,g=b.y;0>b.x&&(d=0);b.x>boardWidth&&(d=boardWidth);0>b.y&&(g=0);b.y>boardHeight&&(g=boardHeight);return{x:d,y:g}}
var bounceButton=function(b){var d=$(b);d.addClass("activeBrush");setTimeout(function(){d.removeClass("activeBrush")},200)},videoControlInteractable=function(b){var d=void 0;return{activated:!1,rehome:function(b){},down:function(b){return!1},move:function(b){return!1},up:function(d){var n=Modes.select.handlesAtZoom();d=d.x-b.x;if(d<n)b.getState().paused?b.play():b.pause();else if(d>b.width-n)b.muted(!b.muted());else{var c=b.getState();b.seek((d-n)/(b.width-2*n)*c.duration)}return!1},getBounds:function(){return d},
deactivate:function(){},render:function(g){if(b.identity in boardContent.videos){var n=Modes.select.handlesAtZoom();d=[b.bounds[0],b.bounds[3],b.bounds[2],b.bounds[3]+n];var n=worldToScreen(d[0],d[1]),c=worldToScreen(d[2],d[3]),r=c.x-n.x,e=c.y-n.y,q=b.getState();g.globalAlpha=1;g.setLineDash([]);g.strokeStyle="black";g.font=sprintf("%spx FontAwesome",e);g.fillStyle="white";g.fillRect(n.x,n.y,e,e);g.fillStyle="black";q.paused?g.fillText("\uf04b",n.x,c.y):g.fillText("\uf04c",n.x,c.y);var B=n.x+e,k=
r-e;g.fillStyle="black";g.fillRect(B,n.y,k,e);g.fillStyle="blue";k*=q.currentTime/q.duration;g.fillRect(B,n.y,k,e);r=n.x+(r-e);g.fillStyle="white";g.fillRect(r,n.y,e,e);g.fillStyle="black";q.muted?g.fillText("\uf0f3",r,c.y):g.fillText("\uf1f6",r,c.y)}}}},Modes=function(){var b=function(){$(".activeTool").removeClass("activeTool");$(".activeMode").addClass("inactiveMode").removeClass("activeMode")},d=function(c,d){b();$(c).addClass("activeMode").removeClass("inactiveMode");$(".activeTool").removeClass("activeTool").addClass("inactiveTool");
$(d).addClass("activeTool").removeClass("inactiveTool")},g={name:"none",activate:function(){Modes.currentMode.deactivate();Modes.currentMode=Modes.none;b()},deactivate:function(){b();unregisterPositionHandlers(board)}},n=function(b,d){b in Modes.canvasInteractables||(Modes.canvasInteractables[b]=[]);Modes.canvasInteractables[b].push(d)};$(function(){var b={opacity:1};(new TWEEN.Tween(b)).delay(1E3).to({opacity:.3},1E3);var d=Modes.select.handlesAtZoom(),e=function(b){var a=Modes.select.handlesAtZoom(),
c=scaleScreenToWorld(DeviceConfiguration.headerHeight)+a,p=scaleScreenToWorld(DeviceConfiguration.footerHeight);return Math.min(viewboxY+viewboxHeight-(p-a/2),Math.max(b,viewboxY+c))},q=function(){var h=void 0;return{getBounds:function(){return h},activated:!1,originalHeight:1,originalWidth:1,rehome:function(a){if(!q.activated){var b=Modes.select.handlesAtZoom(),c=e(a.y);a=a.x+b/2;h=[a-b/2,c-b,a+b/2,c]}},down:function(a){q.activated=!0;Modes.select.dragging=!0;Modes.select.resizing=!1;Modes.select.offset=
a;Modes.select.marqueeWorldOrigin=a;blit()},move:function(a){q.activated&&(q.bounds=[a.x-d,a.y,a.x+d,a.y],Modes.select.offset=a,blit());return!1},deactivate:function(){q.activated=!1;Modes.select.dragging=!1},up:function(a){q.deactivate();var b=batchTransform(),c=a.x-Modes.select.marqueeWorldOrigin.x,d=a.y-Modes.select.marqueeWorldOrigin.y;b.xTranslate=c;b.yTranslate=d;b.inkIds=_.keys(Modes.select.selected.inks);b.textIds=_.keys(Modes.select.selected.texts);b.imageIds=_.keys(Modes.select.selected.images);
b.videoIds=_.keys(Modes.select.selected.videos);b.multiWordTextIds=_.keys(Modes.select.selected.multiWordTexts);_.each(b.multiWordTextIds,function(a){Modes.text.echoesToDisregard[a]=!0});Modes.select.dragging=!1;Modes.text.mapSelected(function(a){a.doc.position.x+=c;a.doc.position.y+=d;a.doc.invalidateBounds()});sendStanza(b);registerTracker(b.identity,function(){Progress.call("onSelectionChanged");blit()});return!1},render:function(a){if(h){var l=worldToScreen(h[0],h[1]),d=worldToScreen(h[2],h[3]).x-
l.x,e=l.x,l=l.y;a.globalAlpha=b.opacity;a.setLineDash([]);a.strokeStyle="black";a.fillStyle="white";a.strokeWidth=2;a.fillRect(e,l,d,d);a.strokeRect(e,l,d,d);a.font=sprintf("%spx FontAwesome",d);a.fillStyle="black";a.fillText("\uf047",e,l+d-4)}}}}(),g=function(){var h=void 0;return{getBounds:function(){return h},activated:!1,originalHeight:1,originalWidth:1,rehome:function(a){if(!g.activated){var b=Modes.select.handlesAtZoom(),c=a.x2;a=e(a.y)-b;h=[c,a,c+b,a+b]}},down:function(a){Modes.select.aspectLocked=
!0;Modes.select.dragging=!1;Modes.select.resizing=!0;g.activated=!0;a=Modes.select.totalSelectedBounds();Modes.select.offset={x:a.x2,y:a.y2};g.rehome(a);blit();return!1},move:function(a){if(g.activated){h=[a.x-d,h[1],a.x+d,h[3]];var b=Modes.select.totalSelectedBounds();Modes.select.offset={x:a.x,y:b.y+(a.x-b.x)/(b.x2-b.x)*b.height};blit()}return!1},deactivate:function(){Modes.select.aspectLocked=!1;g.activated=!1;Modes.select.resizing=!1},up:function(a){g.deactivate();var b=batchTransform(),c=Modes.select.totalSelectedBounds();
b.xScale=(a.x-c.x)/(c.x2-c.x);b.yScale=b.xScale;b.xOrigin=c.x;b.yOrigin=c.y;b.inkIds=_.keys(Modes.select.selected.inks);b.textIds=_.keys(Modes.select.selected.texts);b.imageIds=_.keys(Modes.select.selected.images);b.videoIds=_.keys(Modes.select.selected.videos);b.multiWordTextIds=_.keys(Modes.select.selected.multiWordTexts);_.each(Modes.select.selected.multiWordTexts,function(a,c){Modes.text.echoesToDisregard[c]=!0;var d=a.doc.documentRange();a.doc.select(d.start,d.end);Modes.text.scaleEditor(a.doc,
b.xScale);d=a.doc.width();a.doc.width(d*b.xScale);a.doc.select(0);a.doc.updateCanvas();blit()});registerTracker(b.identity,function(){Progress.call("onSelectionChanged")});sendStanza(b);return!1},render:function(a){if(h){var d=worldToScreen(h[0],h[1]),p=worldToScreen(h[2],h[3]).x-d.x,e=p/10,t=-1*p;a.globalAlpha=b.opacity;a.setLineDash([]);a.strokeStyle="black";a.fillStyle="white";a.strokeWidth=2;a.translate(d.x,d.y);a.rotate(90*Math.PI/180);a.fillRect(0,t,p,p);a.strokeRect(0,t,p,p);a.font=sprintf("%spx FontAwesome",
p);a.fillStyle="black";a.fillText("\uf0b2",e,-1*e)}}}}(),k=function(){var h=void 0;return{activated:!1,getBounds:function(){return h},rehome:function(a){if(!k.activated){var b=Modes.select.handlesAtZoom(),c=a.x2;a=e(a.y2);h=[c,a-b,c+b,a]}},down:function(a){k.activated=!0;Modes.select.dragging=!1;Modes.select.resizing=!0;Modes.select.aspectLocked=!1;a=Modes.select.totalSelectedBounds();Modes.select.offset={x:a.x2,y:a.y2};blit();return!1},move:function(a){k.activated&&(scaleWorldToScreen(Modes.text.minimumWidth),
k.bounds=[a.x-d,a.y-d,a.x+d,a.y+d],Modes.select.offset={x:a.x,y:a.y},blit());return!1},deactivate:function(){k.activated=!1;Modes.select.resizing=!1},up:function(a){k.deactivate();var b=batchTransform(),c=Modes.select.totalSelectedBounds(),d=c.y2-c.y,e=a.y-c.y;b.xScale=(a.x-c.x)/(c.x2-c.x);b.yScale=e/d;b.xOrigin=c.x;b.yOrigin=c.y;b.inkIds=_.keys(Modes.select.selected.inks);b.textIds=_.keys(Modes.select.selected.texts);b.imageIds=_.keys(Modes.select.selected.images);b.videoIds=_.keys(Modes.select.selected.videos);
var r=scale();_.each(Modes.select.selected.multiWordTexts,function(a){0<a.doc.save().length&&(a.doc.width(Math.max(a.doc.width()*b.xScale,Modes.text.minimumWidth/r)),a.doc.updateCanvas(),sendRichText(a))});blit();registerTracker(b.identity,function(){Progress.call("onSelectionChanged");blit()});sendStanza(b);return!1},render:function(a){if(h){var d=worldToScreen(h[0],h[1]),e=worldToScreen(h[2],h[3]).x-d.x,r=e/10,t=-1*e;a.globalAlpha=b.opacity;a.setLineDash([]);a.strokeStyle="black";a.fillStyle="white";
a.strokeWidth=2;a.translate(d.x,d.y);a.rotate(90*Math.PI/180);a.fillRect(0,t,e,e);a.strokeRect(0,t,e,e);a.font=sprintf("%spx FontAwesome",e);a.fillStyle="black";a.fillText("\uf065",r,-1*r)}}}}();n("manualMove",q);n("resizeFree",k);n("resizeAspectLocked",g);Progress.textBoundsChanged.selectionHandles=function(b,a){if(b in Modes.select.selected.multiWordTexts){var c=Modes.select.totalSelectedBounds();q.rehome(c);k.rehome(c);g.rehome(c);blit()}};Progress.onSelectionChanged.selectionHandles=function(){var d=
Modes.select.totalSelectedBounds();Infinity==d.x?b.opacity=0:(b.opacity=1,q.rehome(d),k.rehome(d),g.rehome(d),blit())}});return{pushCanvasInteractable:n,clearCanvasInteractables:function(b){Modes.canvasInteractables[b]=[]},getCanvasInteractables:function(){return _.mapValues(Modes.canvasInteractables,function(b){return _.map(b,function(b){b=_.clone(b);b.bounds=b.getBounds();return b})})},currentMode:g,none:g,canvasInteractables:{},finishInteractableStates:function(){_.forEach(_.keys(Modes.canvasInteractables),
function(b){_.forEach(Modes.canvasInteractables[b],function(b){void 0!=b&&"deactivate"in b&&b.deactivate()})});Modes.select.resizing=!1;Modes.select.dragging=!1;Modes.select.aspectLocked=!1},text:function(){var c,r,e,q,g,k,h,a,l=function(a,b){var c=Modes.text.minimumWidth/scale(),c=Modes.text.editorFor({bounds:[a.x,a.y,a.x,a.y],identity:sprintf("%s_%s_%s",UserSettings.getUsername(),Date.now(),_.uniqueId()),privacy:Privacy.getCurrentPrivacy(),slide:Conversations.getCurrentSlideJid(),target:"presentationSpace",
requestedWidth:c,width:c,height:0,x:a.x,y:a.y,type:"multiWordText",author:UserSettings.getUsername(),words:[]});c.doc.load(b);return c},p=function(a){return function(){var b=!1;_.each(boardContent.multiWordTexts,function(c){if(c.doc.isActive){b=!0;var d=c.doc.selectedRange();carota.runs.nextInsertFormatting={};d.setFormatting(a,!0!==d.getFormatting()[a]);c.doc.updateCanvas();0<c.doc.save().length&&sendRichText(c)}});if(!b){carota.runs.nextInsertFormatting=carota.runs.nextInsertFormatting||{};var c=
carota.runs.nextInsertFormatting[a]=!carota.runs.nextInsertFormatting[a];$(sprintf(".font%sSelector",_.capitalize(a))).toggleClass("active",c)}blit()}},E=function(a,b){return function(){var c=!1;b=b||$(this).val();_.each(boardContent.multiWordTexts,function(d){d.doc.isActive&&(c=!0,carota.runs.nextInsertFormatting={},d.doc.selectedRange().setFormatting(a,b),carota.runs.nextInsertFormatting=carota.runs.nextInsertFormatting||{},carota.runs.nextInsertFormatting[a]=b,d.doc.updateCanvas(),d.doc.claimFocus(),
0<d.doc.save().length&&sendRichText(d))});c||(carota.runs.nextInsertFormatting=carota.runs.nextInsertFormatting||{},carota.runs.nextInsertFormatting[a]=b);blit()}},t=function(a,b){var c=a.selectedRange(),d=0,e=[],t=carota.runs.defaultFormatting.size;a.runs(function(b){b=_.size(b.text);b=d+b;a.select(d,b,!0);var c=a.selectedRange().getFormatting().size||t;_.each(_.range(d,b),function(){e.push(c)});d=b;t=c},a.range(0,c.end));d=c.start;a.runs(function(c){c=d+c.text.length;a.select(d,c,!0);a.selectedRange().setFormatting("size",
e[d]*b);d=c},a.range(c.start,c.end));a.select(c.start,c.end,!0);a.invalidateBounds();return e},y=function(a){return function(){_.each(boardContent.multiWordTexts,function(b){b=b.doc;b.isActive&&(b=t(b,a),carota.runs.defaultFormatting.newBoxSize=1<a?_.max(b):_.min(b))})}};$(function(){q=$(".fontBoldSelector");g=$(".fontItalicSelector");k=$(".fontUnderlineSelector");$("#textDropdowns");$("#fontOptions");c=$("#fontFamilySelector");r=$("#fontSizeSelector");e=$("#fontColorSelector");h=$("#fontLarger");
a=$("#fontSmaller");$("#justifySelector");$("#presetFitToText");$("#presetRunToEdge");$("#presetNarrow");$("#presetWiden");$("#presetFullscreen");$("#presetCenterOnScreen");var b=c.find(".fontFamilyOption").clone(),d=r.find(".fontSizeOption").clone(),t=e.find(".fontColorOption").clone();Fonts.getAllFamilies().map(function(a){c.append(b.clone().attr("value",a).text(a))});Fonts.getAllSizes().map(function(a){r.append(d.clone().attr("value",a).text(a))});Colors.getAllNamedColors().map(function(a){e.append(t.clone().attr("value",
a.rgb).text(a.name))});h.on("click",y(1.2));a.click(y(.8));q.click(p("bold"));g.click(p("italic"));k.click(p("underline"));var l={red:"#ff0000",blue:"#0000ff",black:"#000000",yellow:"#ffff00",green:"#00ff00"};_.each(["red","blue","black","yellow","green"],function(a){$(sprintf("#%sText",a)).click(function(){$("#textTools .fa-tint").removeClass("active");$(this).addClass("active");Modes.text.refocussing=!0;E("color",[l[a],255])()})})});var w=function(a,b,c){(a=1==a[c])&&(carota.runs.nextInsertFormatting[c]=
a);b.toggleClass("active",a)},z=function(a,b,c,d){var e=_.isEqual(a[c],d);c in a&&e&&(carota.runs.nextInsertFormatting[c]=d);b.toggleClass("active",e)},v=function(){return[$("#blackText"),$("#redText"),$("#blueText"),$("#yellowText"),$("#greenText")]},A=v(),u=function(a){carota.runs.nextInsertFormatting=carota.runs.nextInsertFormatting||{};w(a,q,"bold");w(a,g,"italic");w(a,k,"underline");z(a,A[0],"color",["#000000",255]);z(a,A[1],"color",["#ff0000",255]);z(a,A[2],"color",["#0000ff",255]);z(a,A[3],
"color",["#ffff00",255]);z(a,A[4],"color",["#00ff00",255])};return{name:"text",echoesToDisregard:{},minimumWidth:240,minimumHeight:function(){return 3*Modes.select.resizeHandleSize},"default":{fontSize:12,bold:!1,underline:!1,italic:!1,color:["#000000",255]},invalidateSelectedBoxes:function(){Modes.text.mapSelected(function(a){a.doc.invalidateBounds()})},getSelectedRanges:function(){return _.map(boardContent.multiWordTexts,function(a){var b=a.doc.selectedRange();return{identity:a.identity,start:b.start,
end:b.end,text:b.plainText()}})},getLinesets:function(){return _.map(boardContent.multiWordTexts,function(a){a.doc.layout();return _.map(a.doc.frame.lines,function(a){return a.positionedWords.length})})},mapSelected:function(a){var b=Modes.select.selected.multiWordTexts;_.each(boardContent.multiWordTexts,function(c){c.identity in b&&a(c)})},scaleEditor:t,scrollToCursor:function(a){var b=a.bounds,c=a.doc.selectedRange().start;a=a.doc.getCaretCoords(c);var c=Math.floor(a.t/a.h),d=Math.floor(scaleScreenToWorld(boardContext.height)/
a.h);if(DeviceConfiguration.hasOnScreenKeyboard()){var c=Math.min(c,Math.max(0,d-2))*a.h,d=Math.max(b[2]-b[0],scaleWorldToScreen(10*a.h)),e=d/(boardWidth/boardHeight);DeviceConfiguration.setKeyboard(!0);TweenController.zoomAndPanViewbox(b[0],b[1]-c+a.t,d,e)}else b=Math.max(0,Math.floor(a.t/a.h)-(Math.floor((viewboxHeight-(b[1]-viewboxY))/a.h)-8))*a.h,0!=b&&TweenController.zoomAndPanViewbox(viewboxX,viewboxY+b,viewboxWidth,viewboxHeight)},refocussing:!1,editorFor:function(a){var b=boardContent.multiWordTexts[a.identity];
b||(b=boardContent.multiWordTexts[a.identity]=a);if(!b.doc){var c=a.author==UserSettings.getUsername();b.doc=carota.editor.create($("<div />",{id:sprintf("t_%s",a.identity)}).appendTo($("#textInputInvisibleHost"))[0],board[0],a);if(c){var d=_.debounce(function(){var a=boardContent.multiWordTexts[b.identity];a&&(a.target="presentationSpace",a.slide=Conversations.getCurrentSlideJid(),a.audiences=ContentFilter.getAudiences(),sendRichText(a),incorporateBoardBounds(b.bounds))},1E3);Progress.beforeChangingAudience[a.identity]=
function(){d.flush();delete Progress.beforeChangingAudience[a.identity]};Progress.beforeLeavingSlide[a.identity]=function(){d.flush();delete Progress.beforeLeavingSlide[a.identity]};b.doc.contentChanged(d);b.doc.contentChanged(function(){Modes.text.scrollToCursor(b);blit()});b.doc.selectionChanged(function(a,b){if(Modes.text.refocussing)Modes.text.refocussing=!1;else{var c=a();u(c,v());blit()}})}}b.doc.position={x:a.x,y:a.y};b.doc.width(a.width);return b},oldEditorAt:function(a,b,c,d){var e=UserSettings.getUsername(),
t=[d.x-10,d.y-10,d.x+10,d.y+10];a=_.values(boardContent.texts).filter(function(a){return intersectRect(a.bounds,t)&&a.author==e});return 0<a.length?a[0]:!1},editorAt:function(a,b,c,d){var e=UserSettings.getUsername(),t=[d.x-10,d.y-10,d.x+10,d.y+10];a=_.values(boardContent.multiWordTexts).filter(function(a){return intersectRect(a.bounds,t)&&a.author==e}).filter(ContentFilter.exposes);return 0<a.length?a[0]:!1},contextFor:function(a,b){var c={x:b.x-a.position.x,y:b.y-a.position.y};return{node:a.byCoordinate(c.x,
c.y),relativePos:c}},activate:function(){Modes.currentMode.deactivate();Modes.currentMode=Modes.text;d("#textTools","#insertText");$(".activeBrush").removeClass("activeBrush");Progress.call("onLayoutUpdated");var a=0;A=v();u(carota.runs.defaultFormatting);registerPositionHandlers(board,function(a,b,c,f){if(a=Modes.text.editorAt(a,b,c,f).doc)a.isActive=!0,a.caretVisible=!0,a.mousedownHandler(Modes.text.contextFor(a,f).node)},function(a,b,c,f){(a=Modes.text.editorAt(a,b,c,f).doc)&&a.mousemoveHandler(Modes.text.contextFor(a,
f).node)},function(b,c,d,e){var t=Date.now(),p=Modes.text.oldEditorAt(b,c,d,e),u=Modes.text.editorAt(b,c,d,e);_.each(boardContent.multiWordTexts,function(a){a.doc.isActive=a.doc.identity==u.identity;0<a.doc.selection.start+a.doc.selection.end&&a.doc.identity!=u.identity&&(a.doc.select(0,0),a.doc.updateCanvas());0==a.doc.documentRange().plainText().trim().length&&(delete boardContent.multiWordTexts[a.identity],blit())});Modes.select.clearSelection();p?(t=batchTransform(),t.isDeleted=!0,"texts"in Modes.select.selected&&
(t.textIds=[p.identity]),sendStanza(t),p=l({x:p.x,y:p.y},[{text:p.text,italic:"italic"==p.style,bold:"bold"==p.weight,underline:"underline"==p.decoration,color:p.color,size:p.size}]),t=p.doc,t.select(0,1),boardContent.multiWordTexts[p.identity]=p,e={multiWordTexts:{}},e.multiWordTexts[p.identity]=boardContent.multiWordTexts[p.identity],Modes.select.setSelection(e),e=u=p,e.privacy=Privacy.getCurrentPrivacy(),e.target="presentationSpace",e.slide=Conversations.getCurrentSlideJid(),sendRichText(e),incorporateBoardBounds(u.bounds),
e=t.byOrdinal(0),t.mousedownHandler(e),t.mouseupHandler(e)):u?(p=u.doc,e=Modes.text.contextFor(p,e),500>=t-a?p.dblclickHandler(e.node):p.mouseupHandler(e.node),a=t,e={multiWordTexts:{}},e.multiWordTexts[u.identity]=u,Modes.select.setSelection(e)):(p=l(e,[{text:" ",italic:1==carota.runs.nextInsertFormatting.italic,bold:1==carota.runs.nextInsertFormatting.bold,underline:1==carota.runs.nextInsertFormatting.underline,color:carota.runs.nextInsertFormatting.color||carota.runs.defaultFormatting.color,size:carota.runs.defaultFormatting.newBoxSize/
scale()}]),t=p.doc,t.select(0,1),boardContent.multiWordTexts[p.identity]=p,e={multiWordTexts:{}},e.multiWordTexts[p.identity]=boardContent.multiWordTexts[p.identity],Modes.select.setSelection(e),u=p,e=t.byOrdinal(0),t.mousedownHandler(e),t.mouseupHandler(e));u.doc.invalidateBounds();u.doc.isActive=!0;Progress.historyReceived.ClearMultiTextEchoes=function(){Modes.text.echoesToDisregard={}};Progress.call("onSelectionChanged",[Modes.select.selected])})},handleDrop:function(a,b,c){if(0<a.length){a=carota.html.parse(a,
{});b=screenToWorld(b,c);Modes.text.activate();Date.now();Modes.select.clearSelection();var d=l(b,[{text:" ",italic:1==carota.runs.nextInsertFormatting.italic,bold:1==carota.runs.nextInsertFormatting.bold,underline:1==carota.runs.nextInsertFormatting.underline,color:carota.runs.nextInsertFormatting.color||carota.runs.defaultFormatting.color,size:carota.runs.defaultFormatting.newBoxSize/scale()}]);b=d.doc;b.select(0,1);boardContent.multiWordTexts[d.identity]=d;c={multiWordTexts:{}};c.multiWordTexts[d.identity]=
boardContent.multiWordTexts[d.identity];Modes.select.setSelection(c);editor=d;c=b.byOrdinal(0);b.mousedownHandler(c);b.mouseupHandler(c);editor.doc.invalidateBounds();editor.doc.isActive=!0;editor.doc.load(a);Progress.historyReceived.ClearMultiTextEchoes=function(){Modes.text.echoesToDisregard={}};Modes.text.scrollToCursor(editor);a=boardContent.multiWordTexts[editor.identity];a.privacy=Privacy.getCurrentPrivacy();a.target="presentationSpace";a.slide=Conversations.getCurrentSlideJid();sendRichText(a);
Progress.call("onSelectionChanged",[Modes.select.selected])}},deactivate:function(){DeviceConfiguration.setKeyboard(!1);b();unregisterPositionHandlers(board);_.each(boardContent.multiWordTexts,function(a){a.doc.isActive=!1;0==a.doc.documentRange().plainText().trim().length&&delete boardContent.multiWordTexts[a.identity]});Modes.select.clearSelection();blit()}}}(),video:function(){var c={},g=void 0,e=void 0,q=function(){g.hide();$("#imageWorking").hide();$("#imageFileChoice").show();var a=e.wrap("<form>").closest("form").get(0);
void 0!=a&&a.reset();e.unwrap()},n=function(a){if(void 0!=c&&void 0!=c.fileUpload&&void 0!=a){$("#videoWorking").show();$("#videoFileChoice").hide();var b=new FileReader;b.onload=function(b){var d=$("<video/>"),e=d[0],l=b.target.result;e.addEventListener("loadeddata",function(b){b=e.videoHeight;c.width=e.videoWidth;c.height=b;c.video=d;c.videoSrc=l;a()},!1);d.append($("<source />",{src:l,type:"video/mp4"}));d.load()};b.readAsDataURL(c.fileUpload)}},k=function(){if("imageDefinition"==c.type){WorkQueue.pause();
var a=Date.now(),b=sprintf("%s%s",UserSettings.getUsername(),a),d=Conversations.getCurrentSlideJid(),b=sprintf("/uploadDataUri?jid=%s&filename=%s",d.toString(),encodeURI(b));$.ajax({url:b,type:"POST",success:function(b){b=$(b).find("resourceUrl").text().trim();var e={type:"video",author:UserSettings.getUsername(),timestamp:a,identity:b,slide:d.toString(),source:b,bounds:[c.x,c.y,c.x+c.width,c.y+c.height],width:c.width,height:c.height,target:"presentationSpace",privacy:Privacy.getCurrentPrivacy(),
x:c.x,y:c.y,audiences:_.map(Conversations.getCurrentGroup(),"id").concat(ContentFilter.getAudiences()).map(audienceToStanza)};registerTracker(b,function(){var a=Modes.select.handlesAtZoom(),b=e.x,c=e.y,d=Math.max(e.width,viewboxWidth),p=Math.max(e.height,viewboxHeight);Modes.select.activate();IncludeView.specific(b-a,c-a,d+2*a,p+2*a);Modes.select.clearSelection();Modes.select.selected.videos[e.identity]=boardContent.videos[e.identity];Progress.call("onSelectionChanged",[Modes.select.selected])});
sendStanza(e);q();WorkQueue.gracefullyResume()},error:function(a){console.log("Image upload ex",a);resetImageUpload();errorAlert("Upload failed.  This image cannot be processed, either because of image protocol issues or because it exceeds the maximum image size.");WorkQueue.gracefullyResume()},data:c.videoSrc,cache:!1,contentType:!1,processData:!1})}},h=!1;$(function(){h||(h=!0,g=$("#videoInsertOptions").css({position:"absolute",left:0,top:0}),$("#videoInsertOptionsClose").click(Modes.select.activate),
e=$("#videoFileChoice").attr("accept","video/mp4"),e[0].addEventListener("change",function(a){a=(a.target.files||a.dataTransfer.files)[0];0==a.type.indexOf("video")&&(c.fileUpload=a);n(k)},!1),q())});Progress.beforeLeavingSlide.videos=function(){"videos"in boardContent&&_.forEach(boardContent.videos,function(a){null!=a&&void 0!=a&&"destroy"in a&&a.destroy()})};return{activate:function(){Modes.currentMode.deactivate();Modes.currentMode=Modes.video;d("#insertTools","#videoMode");$(".activeTool").removeClass("activeTool").addClass("inactiveTool");
$("#insertMode").addClass("activeTool").removeClass("inactiveTool");$(".toolbar.active").removeClass("active");$("#videoMode").addClass("active");$("#insertTools .insetColumn").hide();$("#videoTools").show();var a=screenToWorld(10,10);c={type:"imageDefinition",screenX:10,screenY:10,x:a.x,y:a.y};Progress.call("onLayoutUpdated");g.show()},deactivate:function(){q();b()}}}(),image:function(){var c={},g=void 0,e=void 0,q=function(){g.hide();$("#imageWorking").hide();$("#imageFileChoice").show();var a=
e.wrap("<form>").closest("form").get(0);void 0!=a&&a.reset();e.unwrap()},n=function(){var a=function(a,b,c,d){for(var f=b*c;f>a;)b*=.8,c*=.8,f=b*c;return{w:b,h:c,q:d}},b={"native":{resizeFunc:function(a,b){return{w:a,h:b,q:1}},selector:"#imageInsertNative"},optimized:{resizeFunc:function(b,c){return a(1*d,b,c,.4)},selector:"#imageInsertOptimized"},highDef:{resizeFunc:function(b,c){return a(3*d,b,c,.8)},selector:"#imageInsertHighDef"}},c=b.optimized,d=1048576,e=function(){_.forEach(b,function(a){var b=
$(a.selector);c.selector==a.selector?b.addClass("activeBrush"):b.removeClass("activeBrush")})};$(function(){_.forEach(b,function(a){$(a.selector).on("click",function(){c=a;e()})});e()});return{reapplyVisualStyle:e,changeMode:function(a){a in b&&(c=b[a],e())},getResizeFunction:function(){return c.resizeFunc}}}(),k=function(a,b){var d=void 0==b?c:b;if(void 0==d||void 0==d.fileUpload||void 0==a)console.log("returning because currentImage is empty",c);else{$("#imageWorking").show();$("#imageFileChoice").hide();
var e=new FileReader;e.onload=function(b){var c=b.target.result;h(c,d,a,function(a){return c.length<a})};e.readAsDataURL(d.fileUpload)}},h=function(a,b,d,e){var g=void 0!=b?b:c,l=$("<canvas/>"),q=new Image;0!=a.indexOf("data")&&q.setAttribute("crossOrigin","Anonymous");q.onerror=function(a){errorAlert("Error dropping image","The source server you're dragging the image from does not allow dragging the image directly.  You may need to download the image first and then upload it.")};q.onload=function(b){var c=
q.width,f=q.height,h=n.getResizeFunction()(c,f);b=h.w;var k=h.h,h=h.q;l.width=c;l.height=f;l.attr("width",c);l.attr("height",f);l.css({width:px(c),height:px(f)});var r=l[0].getContext("2d");r.rect(0,0,c,f);r.fillStyle="white";r.fill();r.drawImage(q,0,0,c,f);c=multiStageRescale(l[0],b,k);g.width=b;g.height=k;g.resizedImage=c.toDataURL("image/jpeg",h);e(g.resizedImage.length)&&(g.resizedImage=a);d(g)};q.src=a},a=function(a){if("imageDefinition"==a.type){WorkQueue.pause();var b=Date.now(),c=sprintf("%s%s%s",
UserSettings.getUsername(),b,_.uniqueId()),d=Conversations.getCurrentSlideJid(),c=sprintf("/uploadDataUri?jid=%s&filename=%s",d.toString(),encodeURI(c));$.ajax({url:c,type:"POST",success:function(c){c=$(c).find("resourceUrl").text().trim();var e={type:"image",author:UserSettings.getUsername(),timestamp:b,tag:'{"author":"'+UserSettings.getUsername()+'","privacy":"'+Privacy.getCurrentPrivacy()+'","id":"'+c+'","isBackground":false,"zIndex":0,"timestamp":-1}',identity:c,slide:d.toString(),source:c,bounds:[a.x,
a.y,a.x+a.width,a.y+a.height],width:a.width,height:a.height,x:a.x,y:a.y,target:"presentationSpace",privacy:Privacy.getCurrentPrivacy(),audiences:_.map(Conversations.getCurrentGroup(),"id").concat(ContentFilter.getAudiences()).map(audienceToStanza)};registerTracker(c,function(){var a=Modes.select.handlesAtZoom(),b=e.x,c=e.y,d=Math.max(e.width,viewboxWidth),g=Math.max(e.height,viewboxHeight);Modes.select.activate();IncludeView.specific(b-a,c-a,d+2*a,g+2*a);Modes.select.clearSelection();Modes.select.selected.images[e.identity]=
boardContent.images[e.identity];Progress.call("onSelectionChanged",[Modes.select.selected])});sendStanza(e);q();WorkQueue.gracefullyResume();zoomToFit()},error:function(a){console.log(a);q();errorAlert("Upload failed.  This image cannot be processed, either because of image protocol issues or because it exceeds the maximum image size.");WorkQueue.gracefullyResume()},data:a.resizedImage,cache:!1,contentType:!1,processData:!1})}},l=!1;$(function(){l||(l=!0,g=$("#imageInsertOptions").css({position:"absolute",
left:0,top:0}),$("#imageInsertOptionsClose").click(Modes.select.activate),e=$("#imageFileChoice").attr("accept","image/*"),e[0].addEventListener("change",function(b){try{var d=(b.target.files||b.dataTransfer.files)[0];0==d.type.indexOf("image")&&(c.fileUpload=d);k(a)}catch(e){console.log("imageFileChoiceHandleChanged exception:",e)}},!1),q())});return{activate:function(){Modes.currentMode.deactivate();Modes.currentMode=Modes.image;d("#insertTools","#imageMode");$(".activeTool").removeClass("activeTool").addClass("inactiveTool");
$("#insertMode").addClass("activeTool").removeClass("inactiveTool");$(".toolbar.active").removeClass("active");$("#imageMode").addClass("active");$("#insertTools .insetColumn").hide();$("#imageTools").show();var a=screenToWorld(10,10);c={type:"imageDefinition",screenX:10,screenY:10,x:a.x,y:a.y};Progress.call("onLayoutUpdated");n.reapplyVisualStyle();g.show()},handleDroppedSrc:function(b,c,d){var e=screenToWorld(c,d);h(b,{type:"imageDefinition",screenX:c,screenY:d,x:e.x,y:e.y},a,function(a){return!1})},
handleDrop:function(b,c,d){var e=0,g=[];console.log("handling drop:",b,c,d);var l=function(b,l){try{if(void 0!=b&&null!=b&&"type"in b&&0==b.type.indexOf("image")&&!_.some(g,function(a){return a==b})){var q=screenToWorld(c,d+e),f={type:"imageDefinition",screenX:c,screenY:d+e,x:q.x,y:q.y};f.fileUpload=b;g.push(b);k(a,f);e+=50}}catch(h){console.log("could not processFile:",b,l)}};_.forEach(b.files,function(a){l(a,"file")});_.forEach(b.items,function(a){try{var b=a.getAsFile(0);l(b,"item")}catch(c){console.log("could not get item as file:",
c)}})},deactivate:function(){q();b()}}}(),pan:{name:"pan",activate:function(){Modes.currentMode.deactivate();d("#panTools","#panMode");Modes.currentMode=Modes.pan;var b,g;registerPositionHandlers(board,function(d,q,n){takeControlOfViewbox(!0);b=d;g=q},function(d,q,n){Pan.translate(-1*(d-b),-1*(q-g));b=d;g=q},function(b,c,d){})},deactivate:function(){b();unregisterPositionHandlers(board)}},select:function(){var c=!1,g=function(){Modes.select.selected={images:{},texts:{},inks:{},multiWordTexts:{},videos:{}};
Progress.call("onSelectionChanged",[Modes.select.selected])},e=[{selCatName:"inks",boardCatName:"inks",filterFunc:function(a){return!a.isHighlighter}},{selCatName:"inks",boardCatName:"highlighters",filterFunc:function(a){return a.isHighlighter}},{selCatName:"images",boardCatName:"images",filterFunc:function(a){return!0}},{selCatName:"texts",boardCatName:"texts",filterFunc:function(a){return!0}},{selCatName:"multiWordTexts",boardCatName:"multiWordTexts",filterFunc:function(a){return!0}},{selCatName:"videos",
boardCatName:"videos",filterFunc:function(a){return!0}}],q=_.debounce(function(){var a=!1;_.forEach(e,function(b){var c=b.selCatName,d=b.boardCatName;if(Modes&&Modes.select&&Modes.select.selected&&c in Modes.select.selected){var e=Modes.select.selected[c];_.forEach(e,function(c){b.filterFunc(c)&&(e&&d in boardContent&&c&&c.identity in boardContent[d]?e[c.identity]=boardContent[d][c.identity]:(a=!0,delete e[c.identity]))})}});a&&Progress.call("onSelectionChanged",[Modes.select.selected])},100),n=function(){if(void 0!=
Modes.select.selected&&c&&"Blacklist"in window){var a=Modes.select.selected;Blacklist.banSelection(Conversations.getCurrentConversationJid(),Conversations.getCurrentSlideJid(),a.inks,a.texts,a.multiWordTexts,a.images,a.videos)}g()},k=function(){(c=Conversations.shouldModifyConversation()?!c:!1)?$("#administerContent").addClass("activeBrush"):$("#administerContent").removeClass("activeBrush");g();blit()},h=function(a){Conversations.shouldModifyConversation(a)?($("#ban").show(),$("#ban").removeClass("disabledButton"),
$("#administerContent").show(),$("#administerContent").removeClass("disabledButton")):($("#ban").addClass("disabledButton"),$("#ban").hide(),$("#administerContent").addClass("disabledButton"),$("#administerContent").hide());c?$("#administerContent").addClass("activeBrush"):$("#administerContent").removeClass("activeBrush")};Progress.onBoardContentChanged.ModesSelect=q;Progress.onViewboxChanged.ModesSelect=q;Progress.onSelectionChanged.ModesSelect=function(a){a&&(Modes.select.selected=a,"images"in
a&&0<_.size(a.images)||"inks"in a&&0<_.size(a.inks)||"texts"in a&&0<_.size(a.texts)||"multiWordTexts"in a&&0<_.size(a.multiWordTexts)||"videos"in a&&0<_.size(a.videos)?($("#delete").removeClass("disabledButton"),$("#resize").removeClass("disabledButton"),c?($("#ban").removeClass("disabledButton"),$("#delete").addClass("disabledButton")):($("#ban").addClass("disabledButton"),$("#delete").removeClass("disabledButton"))):($("#delete").addClass("disabledButton"),$("#resize").addClass("disabledButton"),
$("#ban").addClass("disabledButton")),"Conversations"in window&&Conversations.shouldModifyConversation()?$("#ban").show():$("#ban").hide(),Modes.currentMode==Modes.select&&$("#selectionAdorner").empty())};Progress.historyReceived.ModesSelect=g;Progress.conversationDetailsReceived.ModesSelect=function(a){c&&!Conversations.shouldModifyConversation(a)&&(c=!1);Conversations.shouldModifyConversation(a)?($("#administerContent").show().unbind("click").bind("click",k),$("#ban").unbind("click").show().bind("click",
n)):($("#administerContent").hide().unbind("click"),$("#ban").hide().unbind("click"));h(a)};return{name:"select",isAdministeringContent:function(){return c},updateAdministerContentVisualState:h,selected:{images:{},texts:{},inks:{},multiWordTexts:{},videos:{}},resizeHandleSize:20,setSelection:function(a){Modes.select.selected=_.merge(Modes.select.selected,a)},handlesAtZoom:function(){var a=scale();return Modes.select.resizeHandleSize/a},totalSelectedBounds:Bench.track("Modes.select.totalSelectedBounds",
function(){var a={x:Infinity,y:Infinity,x2:-Infinity,y2:-Infinity},b=function(b){b=b.bounds;a.x=Math.min(a.x,b[0]);a.y=Math.min(a.y,b[1]);a.x2=Math.max(a.x2,b[2]);a.y2=Math.max(a.y2,b[3])};_.forEach(Modes.select.selected.inks,b);_.forEach(Modes.select.selected.texts,b);_.forEach(Modes.select.selected.images,b);_.forEach(Modes.select.selected.multiWordTexts,b);_.forEach(Modes.select.selected.videos,b);a.width=a.x2-a.x;a.height=a.y2-a.y;a.tl=worldToScreen(a.x,a.y);a.br=worldToScreen(a.x2,a.y2);return a}),
offset:{x:0,y:0},marqueeWorldOrigin:{x:0,y:0},resizing:!1,dragging:!1,aspectLocked:!1,clearSelection:g,activate:function(){Modes.currentMode.deactivate();Modes.currentMode=Modes.select;d("#selectTools","#selectMode");var a={x:0,y:0},b=$("<div/>",{id:"selectMarquee"}),e=$("#selectionAdorner");$("#delete").bind("click",function(){if(void 0!=Modes.select.selected&&!c){var a=batchTransform();a.isDeleted=!0;"inks"in Modes.select.selected&&(a.inkIds=_.keys(Modes.select.selected.inks));"texts"in Modes.select.selected&&
(a.textIds=_.keys(Modes.select.selected.texts));"images"in Modes.select.selected&&(a.imageIds=_.keys(Modes.select.selected.images));"multiWordTexts"in Modes.select.selected&&(a.multiWordTextIds=_.keys(Modes.select.selected.multiWordTexts));"videos"in Modes.select.selected&&(a.videoIds=_.keys(Modes.select.selected.videos));sendStanza(a);_.forEach(_.union(Modes.select.selected.inks,Modes.select.selected.texts,Modes.select.selected.images,Modes.select.selected.multiWordTexts,Modes.select.selected.videos),
function(a){Progress.call("onCanvasContentDeleted",[a])});g()}});var q=function(a){a("images");a("texts");a("multiWordTexts");a("inks");a("videos")};Modes.select.dragging=!1;h();Modes.select.resizing=!1;registerPositionHandlers(board,function(c,d,g,q,h){Modes.select.resizing=!1;Modes.select.dragging=!1;a={x:c,y:d};Modes.select.marqueeWorldOrigin=q;if(!h.ctrl&&Infinity!=Modes.select.totalSelectedBounds().x){c=3/scale();var k=[q.x-c,q.y-c,q.x+c,q.y+c];Modes.select.dragging=_.some(["images","texts",
"inks","multiWordTexts","videos"],function(a){return _.some(Modes.select.selected[a],function(a){return a?intersectRect(a.bounds,k):!1})})}Modes.select.dragging?(Modes.select.offset=q,updateStatus("SELECT -> DRAG")):Modes.select.resizing?updateStatus("SELECT -> RESIZE"):(e.empty(),e.append(b),b.show(),updateMarquee(b,a,a))},function(c,d,e,g,q){c={x:c,y:d};Modes.select.offset=g;Modes.select.dragging?blit():Modes.select.resizing?blit():updateMarquee(b,a,c)},function(a,d,e,g,h){function k(a,b){var c=
null;0<_.size(a)&&(c=_.reverse(_.sortBy(a,"timestamp"))[0]);return c}function u(a){return a&&null!==a&&"undefined"!==a}WorkQueue.gracefullyResume();try{var f=g.x-Modes.select.marqueeWorldOrigin.x,p=g.y-Modes.select.marqueeWorldOrigin.y;15>Math.abs(f)+Math.abs(p)&&(Modes.select.dragging=!1);if(Modes.select.dragging){Modes.select.totalSelectedBounds();_.each(Modes.select.selected.multiWordTexts,function(a,b){Modes.text.echoesToDisregard[b]=!0});Modes.text.mapSelected(function(a){a.doc.position.x+=f;
a.doc.position.y+=p;a.doc.invalidateBounds()});var r=batchTransform();r.xTranslate=f;r.yTranslate=p;r.inkIds=_.keys(Modes.select.selected.inks);r.textIds=_.keys(Modes.select.selected.texts);r.imageIds=_.keys(Modes.select.selected.images);r.videoIds=_.keys(Modes.select.selected.videos);r.multiWordTextIds=_.keys(Modes.select.selected.multiWordTexts);Modes.select.dragging=!1;registerTracker(r.identity,function(){Progress.call("onSelectionChanged");blit()});sendStanza(r)}else{var n=rectFromTwoPoints(Modes.select.marqueeWorldOrigin,
g,2),B=[n.left,n.top,n.right,n.bottom],D={images:{},texts:{},inks:{},multiWordTexts:{},videos:{}},L={},M={};q(function(a){$.each(boardContent[a],function(b,d){if(!("bounds"in d)&&"type"in d)switch(d.type){case "text":prerenderText(d);break;case "image":prerenderImage(d);break;case "ink":prerenderInk(d);break;case "video":prerenderVideo(d);break;case "multiWordText":prerenderMultiwordText(d);break;default:d.bounds=[NaN,NaN,NaN,NaN]}1<=overlapRect(B,d.bounds)&&(incrementKey(L,d.author),incrementKey(M,
"any"),c?d.author!=UserSettings.getUsername()&&(D[a][d.identity]=d):d.author==UserSettings.getUsername()&&(D[a][d.identity]=d))})});$.each(boardContent.highlighters,function(a,b){intersectRect(b.bounds,B)&&(incrementKey(L,b.author),c?b.author!=UserSettings.getUsername()&&(D.inks[b.identity]=b):b.author==UserSettings.getUsername()&&(D.inks[b.identity]=b))});q(function(a){$.each(D[a],function(b,c){a in Modes.select.selected||(Modes.select.selected[a]=[]);a in Modes.select.selected&&b in Modes.select.selected[a]?
delete Modes.select.selected[a][b]:Modes.select.selected[a][b]=c})});M.any||Modes.select.clearSelection();if(2>=n.width&&2>=n.height){var O=_.filter(D.inks,function(a){return!a.isHighlighter}),F=k(O,"ink");if(u(F))Modes.select.clearSelection(),Modes.select.selected.inks[F.id]=F;else{var G=k(D.multiWordTexts,"multiWordText");if(u(G))Modes.select.clearSelection(),Modes.select.selected.multiWordTexts[G.id]=G;else{var H=k(D.texts,"text");if(u(H))Modes.select.clearSelection(),Modes.select.selected.texts[H.id]=
H;else{var Q=_.filter(D.inks,function(a){return a.isHighlighter}),I=k(Q,"highlighter");if(u(I))Modes.select.clearSelection(),Modes.select.selected.inks[I.id]=I;else{var J=k(D.videos,"video");if(u(J))Modes.select.clearSelection(),Modes.select.selected.videos[J.id]=J;else{var K=k(D.images,"image");u(K)&&(Modes.select.clearSelection(),Modes.select.selected.images[K.id]=K)}}}}}}Progress.call("onSelectionChanged",[Modes.select.selected])}b.css({width:0,height:0}).hide();blit()}catch(P){console.log("Selection up ex",
P)}})},deactivate:function(){unregisterPositionHandlers(board);b();g();$("#delete").unbind("click");$("#resize").unbind("click");$("#selectionAdorner").empty();$("#selectMarquee").hide();h();blit();blit()}}}(),zoom:{name:"zoom",activate:function(){Modes.currentMode.deactivate();Modes.currentMode=Modes.zoom;d("#zoomTools","#zoomMode");var b=$("<div />",{id:"zoomMarquee"}),g,e={x:0,y:0};Progress.onBoardContentChanged.autoZooming?takeControlOfViewbox(!1):takeControlOfViewbox(!0);registerPositionHandlers(board,
function(d,n,k,h){takeControlOfViewbox(!0);g=h;b.show();b.appendTo($("#selectionAdorner"));e={x:d,y:n};updateMarquee(b,e,e)},function(d,g,k,h){d={x:d,y:g};g=rectFromTwoPoints(d,e);k="left";h="top";d.x==g.left&&(k="right");d.y==g.top&&(h="bottom");d=aspectConstrainedRect(g,k,h);updateMarquee(b,{x:d.right,y:d.bottom},{x:d.left,y:d.top})},function(d,e,k,h){WorkQueue.gracefullyResume();b.hide();d={x:contentOffsetX+h.x,y:contentOffsetY+h.y};e=rectFromTwoPoints(d,{x:contentOffsetX+g.x,y:contentOffsetY+
g.y});2500>scale()*e.width*e.height||(k="left",h="top",d.x==e.left&&(k="right"),d.y==e.top&&(h="bottom"),d=aspectConstrainedRect(e,k,h),IncludeView.specific(d.left,d.top,d.width,d.height))})},deactivate:function(){b();$("#zoomMarquee").remove();unregisterPositionHandlers(board)}},feedback:function(){var c=function(){Conversations.shouldModifyConversation()?$("#participantsButton").unbind("click").on("click",function(){Participants.openMenu()}).show():$("#participantsButton").unbind("click").hide();
switch(currentBackstage){case "quizzes":$("#quizzesButton").addClass(active);break;case "submissions":$("#submissionButton").addClass(active)}};Progress.onConversationJoin.setConversationRole=function(){c()};Progress.conversationDetailsReceived.respectNewPermissions=c;return{name:"feedback",activate:function(){Modes.currentMode.deactivate();Modes.currentMode=Modes.feedback;c();d("#feedbackTools","#feedbackMode");registerPositionHandlers(board,function(b,c,d,g){},function(b,c,d,g){},function(b,c,d,
g){});c()},deactivate:function(){b();unregisterPositionHandlers(board);Progress.call("onLayoutUpdated")}}}(),draw:function(){var c=Brushes.getDefaultBrushes(),g=_.map(c,function(a){return _.clone(a)}),e,q=!1,n=void 0,k=void 0,h=function(a){g[a.index]=a},a=function(){},l=function(){},p=function(){};$(function(){var b,d;$(".activeBrush").removeClass("activeBrush");var y=function(){var a=$("#drawTools");_.each(a.find(".modeSpecificTool.pen"),function(a,b){var c=g[b],d=$(a).css({color:c.color}).click(function(){$(".activeBrush").removeClass("activeBrush");
$(this).addClass("activeBrush");e=c;h(c);Modes.draw.drawingAttributes=e;q=!1;w(c)}).removeClass("fa-tint").removeClass("fa-circle").addClass(c.isHighlighter?"fa-circle":"fa-tint");d.find(".widthIndicator").text(c.width);c==e&&d.addClass("activeBrush")})},w=function(a){var b=$("#colors .dots"),c=$("#sizes .dots"),d=Colors.getAllNamedColors(),g=Brushes.getAllBrushSizes();c.empty();g.map(function(b){var d=n.clone();c.append(d);d.click(function(){a.width=b;h(a);e=a;y();w(a)});var f=Canvas.circle(a.color,
b,50);b==a.width&&d.addClass("activeTool");d.prepend(f);f=b.toString()+"px";d.find(".sizeDotName").append(f)});b.empty();d.map(function(c){var d=k.clone();b.append(d);d.on("click",function(){a.color=c.rgb;e=a;h(a);y();w(a)});d.css("color",c.rgb);"rgb"in c&&c.rgb==a.color&&d.addClass("activeTool");var g=c.name;d.find(".colorDotName").append(g)});d=$("#setPenToHighlighter").unbind("click").on("click",function(){a.isHighlighter=!0;e=a;h(a);y();w(a)});g=$("#setPenToPen").unbind("click").on("click",function(){a.isHighlighter=
!1;e=a;h(a);y();w(a)});"isHighlighter"in e&&e.isHighlighter?(d.addClass("activeTool").addClass("active"),g.removeClass("activeTool").removeClass("active")):(g.addClass("activeTool").addClass("active"),d.removeClass("activeTool").removeClass("active"));Progress.call("onLayoutUpdated")};$("#resetPenButton").click(function(){var a=_.find(c,function(a){return a.id==e.id});void 0!=a&&(e.width=a.width,e.color=a.color,e.isHighlighter=a.isHighlighter,y(),w(e))});n=$("#penSize .sizeDot").clone();k=$("#penColor .colorDot").clone();
e=g[0];y();w(e);var z=$("#drawTools");z.find(".eraser").unbind("click").on("click",function(a){$(".activeBrush").removeClass("activeBrush");$(this).addClass("activeBrush");q=!0;$("#drawDropdowns").hide()});z.find(".advancedTools").unbind("click").on("click",function(){q||(w(e),$("#drawDropdowns").toggle())});$("#closePenDialog").unbind("click").on("click",function(){$("#drawDropdowns").hide()});var v=[];l=function(a,c,e,g,h){A=[];q||h.eraser||(boardContext.strokeStyle=Modes.draw.drawingAttributes.color,
boardContext.fillStyle=Modes.draw.drawingAttributes.color,boardContext.globalAlpha=Modes.draw.drawingAttributes.isHighlighter?.4:1,v=[g.x,g.y,256*e],b=a,d=c,boardContext.beginPath(),boardContext.arc(a,c,Modes.draw.drawingAttributes.width*e/2,0,2*Math.PI),boardContext.fill())};var A=[];d=b=void 0;p=function(a,c,e,g,h){a=Math.round(a);c=Math.round(c);if(q||h.eraser){var k=[g.x-10,g.y-10,g.x+10,g.y+10];e=function(a){$.each(a,function(b,c){if(c.author==UserSettings.getUsername()&&intersectRect(c.bounds,
k)){delete a[c.identity];A.push(c);var d=c.bounds,e=worldToScreen(d[0],d[1]),d=worldToScreen(d[2],d[3]);boardContext.fillRect(e.x,e.y,d.x-e.x,d.y-e.y)}})};boardContext.globalAlpha=.4;boardContext.fillStyle="red";e(boardContent.inks);e(boardContent.highlighters);boardContext.globalAlpha=1}else h=Modes.draw.drawingAttributes.width*e,boardContext.beginPath(),boardContext.lineCap="round",boardContext.lineWidth=h,_.takeRight(v,3),boardContext.moveTo(b,d),boardContext.lineTo(a,c),boardContext.stroke(),
v=v.concat([g.x,g.y,256*e]);b=a;d=c};a=function(a,c,e,g,h){q||h.eraser?(a=batchTransform(),a.isDeleted=!0,a.inkIds=_.map(A,function(a){return a.identity}),_.forEach(A,function(a){Progress.call("onCanvasContentDeleted",[a])}),sendStanza(a)):(h=Modes.draw.drawingAttributes.width*e,boardContext.lineWidth=h,boardContext.beginPath(),boardContext.lineWidth=h,boardContext.lineCap="round",boardContext.moveTo(b,d),boardContext.lineTo(a,c),boardContext.stroke(),v=v.concat([g.x,g.y,256*e]),strokeCollected(v));
boardContext.globalAlpha=1}});return{name:"draw",brushes:g,mousePressure:256,activate:function(){boardContext.setLineDash([]);Modes.currentMode!=Modes.draw&&(Modes.currentMode.deactivate(),Modes.currentMode=Modes.draw,Modes.draw.drawingAttributes=e,d("#drawTools","#drawMode"),$(".activeBrush").removeClass("activeBrush"),q?$("#drawTools").find(".eraser").addClass("activeBrush"):_.each($("#drawTools").find(".modeSpecificTool.pen"),function(a,b){b+1==e.id&&$(a).addClass("activeBrush")}),registerPositionHandlers(board,
l,p,a))},deactivate:function(){$(".activeBrush").removeClass("activeBrush");$("#drawDropdowns").hide();b();WorkQueue.gracefullyResume();unregisterPositionHandlers(board);"customizeBrushPopup"==window.currentBackstage&&window.hideBackstage()}}}(),erase:{activate:function(){Modes.currentMode.deactivate();Modes.currentMode=Modes.erase;registerPositionHandlers(board,function(b,d,e,g){},function(b,d,e,g){},function(b,d,e,g){})},deactivate:function(){unregisterPositionHandlers(board)}},message:function(){var c=
!1,g=void 0,e=void 0,n=void 0,B=void 0,k=void 0,h=void 0,a=void 0,l=void 0,p=void 0,E=void 0,t=function(a){console.log(a);return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(a)},y=function(a){return"false"===$.ajax({url:"https://www.purgomalum.com/service/containsprofanity?text="+a,type:"get",async:!1}).responseText?!0:!1},w=function(b){b.preventDefault();b=!0;for(var c=0,d=l.val().split(",");b&&c<d.length;)b=t(d[c]),console.log(d[c]),c++;b?(l.css("border","2px solid #238823"),m=e.val()||"Checkout our whiteboard at "+
window.location.href,s=a.val()||"Message from Whiteboard user "+UserSettings.getUsername(),b=l.val(),y(s)?(a.css("border","2px solid #238823"),y(m)?(e.css("border","2px solid #238823"),k.html("Sending Email..."),n.show(),$.post("https://api.elasticemail.com/v2/email/send",{apikey:"ba451acf-e504-4c5a-9aea-8b0401d1ec93",bodyHtml:'\n          <div>\n            <div>\n                <p>This email was sent from <span><a href="'+window.location.href+'">Saint Leo White Board</a></span> by '+UserSettings.getUsername()+
"</p>\n            </div>\n            <div>\n\n"+m+"\n\n</div>\n          </div>",to:b,from:"sluwhiteboard@gmail.com",fromName:"Saint Leo Whiteboard",subject:s}).then(function(b){n.hide();!0===b.success?(B.hide(),g.hide(),e.val(""),a.val(""),l.val(""),k.html("Email Sent Successfully!"),setTimeout(function(){v();Modes.select.activate()},1E4)):k.html("Email Send Failed!")})):(e.css("border","2px solid #D2222D"),k.html("Message body contains Innapropriate Content...."))):(a.css("border","2px solid #D2222D"),
k.html("Message subject contains Innapropriate Content...."))):(l.css("border","2px solid #D2222D"),k.html("Invaid Email Address...."))},z=function(){v();unregisterPositionHandlers(board);b();Modes.select.activate()},v=function(){k.html("Send Email");e.css("border","2px solid grey");l.css("border","2px solid grey");a.css("border","2px solid grey");B.show();g.show();n.hide();h.hide();void 0!=B&&B[0].reset();p.text("Send").unbind("click").on("click",w);E.text("Cancel").unbind("click").on("click",z)};
$(function(){c||(c=!0,g=$("#formInfo"),l=$("#form-email"),a=$("#form-subject"),e=$("#form-body"),B=$("#message-form"),k=$("#messageHeading"),n=$("#message-sending"),p=$("#email-send"),E=$("#email-cancel"),h=$("#messageOptions").css({position:"absolute",left:0,top:0}),$messageOptionsClose=$("#messageOptionsClose").click(Modes.select.activate),v())});return{name:"message",activate:function(){Modes.currentMode.deactivate();Modes.currentMode=Modes.message;d("#messageTools","#messageMode");$("#email").addClass("active");
Progress.call("onLayoutUpdated");h.show()},deactivate:function(){v();unregisterPositionHandlers(board);b()}}}()}}();
