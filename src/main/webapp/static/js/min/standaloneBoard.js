var board=function(ua){var U=function(a,b){return void 0!=ua&&a in ua?ua[a]:b},B=$("<canvas/>"),z=B[0].getContext("2d"),Qa=$("<div/>"),k={images:{},highlighters:{},texts:{},multiWordTexts:{},inks:{}},ja=void 0;U("pressureSimilarityThreshold",32);var E=0,H=0,w=80,t=60,F=0,J=0,Y=0,Z=0,aa=320,ba=240,ka=U("inkCoordinatePrecision",Math.pow(10,3));U("lineDrawingThreshold",25);var Ra=U("maxX",2147483647),Sa=U("maxY",2147483647),ea=[],va=function(a){return a*(1<F/J/(F/J)?w/F:t/J)},la=function(a){return a/
(1<F/J/(F/J)?w/F:t/J)},K=function(a,b){var c=va(a)+E,l=va(b)+H;return{x:c,y:l}},O=function(a,b){var c=la(a-E),l=la(b-H);return{x:c,y:l}},Ea=function(){var a=[["black","#000000",255],["red","#ff0000",255],["blue","#0000ff",255],["cyan","#00ffff",255],["green","#00ff00",255],["white","#ffffff",255],["dark grey","#666666",255],["yellow","#ffff00",255],["magenta","#ff00ff",255]],b=a[0],c=function(a){n=parseInt(a,10);if(isNaN(n))return"00";nValue=Math.max(0,Math.min(n,255));a=function(a){internalN=Math.max(0,
Math.min(a,15));return"0123456789ABCDEF".charAt(internalN)};return(a((n-n%16)/16)+a(n%16)).toLowerCase()},l=function(a,b){return parseInt(a.substring(b,b+2).toUpperCase(),16)};return{getAllNamedColors:function(){return _.map(a,function(a){return{name:a[0],rgb:a[1],alpha:a[2],red:l(a[1],1),green:l(a[1],3),blue:l(a[1],5)}})},getNameForColor:function(b){var g=b[0],h=b[1];return(b=_.find(a,function(a){return a[1]==g&&a[2]==h}))?b[0]:"#"+c(h)+g.substring(1,7)},getColorForName:function(d){if(0==d.indexOf("#")&&
7==d.length){var g=255,h=l(d,1),x=l(d,3),q=l(d,5);return[c(h)+c(x)+c(q),g]}return 0==d.indexOf("#")&&9==d.length?(g=l(d,1),h=l(d,3),x=l(d,5),q=l(d,7),[c(h)+c(x)+c(q),g]):(g=_.find(a,function(a){return a[0]==d}))?[g[1],g[2]]:[b[1],b[2]]}}}(),Fa=function(){var a=["sans-serif","serif"],b=[12,14,16,18,20,30,42,60];return{getAllFamilies:function(){return _.map(a,function(a){return a})},getAllSizes:function(){return _.map(b,function(a){return a})}}}(),Ga=function(){var a=[{id:1,width:2,color:"#000000",
isHighlighter:!1},{id:2,width:5,color:"#FF0000",isHighlighter:!1},{id:3,width:8,color:"#00FF00",isHighlighter:!1},{id:4,width:10,color:"#666666",isHighlighter:!1},{id:5,width:30,color:"#FFFF00",isHighlighter:!0}],b=[2,4,5,8,10,16,30];return{getDefaultBrushes:function(){return _.map(a,function(a){return a})},getAllBrushSizes:function(){return _.map(b,function(a){return a})}}}(),D=function(){return{call:function(a,b){b=b||[];$.each(D[a],function(c,l){try{l.apply(l,b)}catch(d){console.log("exception",
a,c,d)}})},onPrivacyChanged:{},onConversationJoin:{},onSelectionChanged:{},onBoardContentChanged:{},onViewboxChanged:{},onLayoutUpdated:{},postRender:{},historyReceived:{},stanzaReceived:{},currentConversationJidReceived:{},currentSlideJidReceived:{},conversationDetailsReceived:{},newConversationDetailsReceived:{},conversationsReceived:{},syncMoveReceived:{},userGroupsReceived:{},usernameReceived:{},userOptionsReceived:{}}}(),S=function(a,b,c,l){var d=!1,g=function(a,b){return{shift:a.shiftKey,ctrl:a.ctrlKey,
alt:a.altKey,eraser:b}};$.each(a,function(a,x){var q=$(x);q.css({"touch-action":"none"});var k=!1,f={},u=function(a){var b=a.originalEvent.pointerId,d="pen"==a.originalEvent.pointerType&&5==a.originalEvent.button,p=q.offset(),g=a.pageX-p.left,p=a.pageY-p.top,c=a.originalEvent.pressure||.5,h=K(g,p),l=f[b]||{pointerId:b,pointerType:a.originalEvent.pointerType,eraser:d,points:[]};l.points.push({x:h.x,y:h.y,screenX:g,screenY:p,z:c});l.eraser=l.eraser||d;f[b]=l;1<_.size(f)&&(0==k&&_.each(f,function(a){a.points=
[_.last(a.points)]}),k=!0);return{pointerType:a.pointerType,eraser:l.eraser,x:g,y:p,z:c,worldPos:h}},v=function(a){var b=a.originalEvent.pointerId,p="pen"==a.originalEvent.pointerType&&5==a.originalEvent.button,g=q.offset(),c=a.pageX-g.left,g=a.pageY-g.top,h=a.originalEvent.pressure||.5,l=K(c,g);delete f[b];k&&0==_.size(f)&&(d=k=!1);return{pointerType:a.pointerType,eraser:p,x:c,y:g,z:h,worldPos:l}},C;try{C="pointerEnabled"in Navigator&&1==Navigator.pointerEnabled||void 0!=PointerEvent}catch(R){C=
!1}if(C){var M=function(){if(1<_.size(f)){L();var a=_.map(_.filter(f,function(a){return 0<_.size(a.points)}),function(a){var b=_.first(a.points);a=_.last(a.points);return[b,a]});f={};var b=_.meanBy(a,function(a){return a[0].x-a[1].x}),d=_.meanBy(a,function(a){return a[0].y-a[1].y});wa.translate(la(b),la(d));var b=_.min(_.map(a,function(a){return a[0].y})),p=_.max(_.map(a,function(a){return a[0].y})),d=_.min(_.map(a,function(a){return a[0].x})),g=_.max(_.map(a,function(a){return a[0].x})),b=p-b,d=
g-d,g=_.min(_.map(a,function(a){return a[1].y})),p=_.max(_.map(a,function(a){return a[1].y})),c=_.min(_.map(a,function(a){return a[1].x})),a=(_.max(_.map(a,function(a){return a[1].x}))-c+(p-g))/2;fa.scale((d+b)/2/a)}};q.bind("pointerdown",function(a){var p=u(a);a.preventDefault();A.pause();1!=_.size(f)||k||(d=!0,b(p.x,p.y,p.z,p.worldPos,g(a,p.eraser)))});q.bind("pointermove",function(a){var b=u(a);a.preventDefault();(a.originalEvent.pointerType==a.POINTER_TYPE_TOUCH||"touch"==a.originalEvent.pointerType&&
1<_.size(f))&&M();1!=_.size(f)||k||d&&c(b.x,b.y,b.z,b.worldPos,g(a,b.eraser))});q.bind("pointerup",function(a){var b=v(a);A.gracefullyResume();a.preventDefault();d&&!k&&l(b.x,b.y,b.z,b.worldPos,g(a,b.eraser));d=!1});C=function(a){v(a);A.gracefullyResume();a.preventDefault();if(d){var b=a.offsetX;a=a.offsetY;f={};A.gracefullyResume();a=K(b,a);b=a.x;a=a.y;b<E?(L(),V.left()):b>=E+w?(L(),V.right()):a<H?(L(),V.up()):a>=H+t&&(L(),V.down());d=!1}d=!1};q.bind("pointerout",C);q.bind("pointerleave",C);q.bind("pointercancel",
C)}else{q.bind("mousedown",function(a){A.pause();var p=q.offset();a.preventDefault();d=!0;var c=a.pageX-p.left,p=a.pageY-p.top,h=K(c,p);b(c,p,.5,h,g(a))});q.bind("mousemove",function(a){if(d){var b=q.offset();a.preventDefault();var p=a.pageX-b.left,b=a.pageY-b.top;c(p,b,.5,K(p,b),g(a))}});q.bind("mouseup",function(a){A.gracefullyResume();a.preventDefault();if(d){var b=q.offset(),p=a.pageX-b.left,b=a.pageY-b.top,c=K(p,b);l(p,b,.5,c,g(a))}d=!1});var ma=function(a,b){A.gracefullyResume();var p=K(a,b),
g=p.x,p=p.y;g<E?(L(),V.left()):g>=E+w?(L(),V.right()):p<H?(L(),V.up()):p>=H+t&&(L(),V.down());d=!1};q.bind("mouseout",function(a){A.gracefullyResume();a.preventDefault();d&&ma(a.offsetX,a.offsetY);d=!1});var p,I=function(a){return{x:average(_.map(a,"x")),y:average(_.map(a,"y"))}},da=function(a){var b=[],p=q.offset();$.each(a,function(a,d){b.push({x:d.pageX-p.left,y:d.pageY-p.top,identifier:d.identifier})});return b};q.bind("touchstart",function(a){A.pause();a.preventDefault();var c=da(a.originalEvent.touches);
if(1==c.length){var c=c[0],h=K(c.x,c.y);d=!0;b(c.x,c.y,.5,h,g(a))}else p=I(c)});q.bind("touchmove",function(a){a.preventDefault();var b=da(a.originalEvent.touches);switch(b.length){case 0:break;case 1:d&&(b=b[0],c(b.x,b.y,.5,K(b.x,b.y),g(a)));break;default:a=I(b);var b=a.x-p.x,h=a.y-p.y;p=a;L();wa.translate(-1*b,-1*h)}});q.bind("touchend",function(a){A.gracefullyResume();a.preventDefault();if(d){var b=q.offset(),p=a.originalEvent.changedTouches[0],c=p.pageX-b.left,b=p.pageY-b.top;0>c||0>b||c>F||b>
J?ma(c,b):l(c,b,.5,K(c,b),g(a))}d=!1});var X=1;q.bind("gesturechange",function(a){A.pause();a.preventDefault();d=!1;a=a.originalEvent.scale;L();fa.scale(X/a);X=a});q.bind("gestureend",function(){A.gracefullyResume();X=1})}});return function(a){d=a}},Ia=function(a,b,c){var l=J/F,d={left:a.left,top:a.top,right:a.right,bottom:a.bottom,width:a.width,height:a.height};a.height/a.width>l?(d.height=a.width*l,c&&(b=a.height-d.height,"center"==c?d.top+=b/2:"bottom"==c&&(d.top+=b))):(d.width=a.height/l,b&&(c=
a.width-d.width,"center"==b?d.left+=c/2:"right"==b&&(d.left+=c)));d.right=d.left+d.width;d.bottom=d.top+d.height;return d},P=function(a,b){return"undefined"!=typeof a&&"undefined"!=typeof b?!(b[0]>a[2]||b[2]<a[0]||b[1]>a[3]||b[3]<a[1]):!1},na=function(a,b){var c,l,d,g;a.x<b.x?(c=a.x,d=b.x):(c=b.x,d=a.x);a.y<b.y?(l=a.y,g=b.y):(l=b.y,g=a.y);return{left:c,top:l,right:d,bottom:g,width:Math.abs(d-c),height:Math.abs(g-l)}},oa=function(a,b,c){b=na(b,c);c=$("#selectionAdorner");jQuery.contains(c,a)||c.append(a);
a.is(":visible")||a.show();a.css({left:G(b.left),top:G(b.top),width:G(b.width),height:G(b.height)})},xa=function(a){var b=a.x,c=a.y;0>a.x&&(b=0);a.x>F&&(b=F);0>a.y&&(c=0);a.y>J&&(c=J);return{x:b,y:c}},Q=function(a){$.each("pointerdown pointermove pointerup pointerout pointerleave pointercancel mouseup mousemove mousedown touchstart touchmove touchend touchcancelled mouseout touchleave gesturechange gesturestart".split(" "),function(b,c){a.unbind(c)});A.gracefullyResume()},T=function(a){isNaN(a[0])||
(k.minX=Math.min(k.minX,a[0]));isNaN(a[1])||(k.minY=Math.min(k.minY,a[1]));isNaN(a[2])||(k.maxX=Math.max(k.maxX,a[2]));isNaN(a[3])||(k.maxY=Math.max(k.maxY,a[3]));k.width=k.maxX-k.minX;k.height=k.maxY-k.minY},ga=function(a){var b=!_.some(a.bounds,function(a){return isNaN(a)||1E4<a||-1E4>a}),c="size"in a?!isNaN(a.size):!0;a="text"in a?0<a.text.length:!0;return b&&c&&a},A=function(){var a=!0,b=[],c=!1,l=function(){var a=b.pop();a?(c=c||a(),l()):(c&&(W(),c=!1),"Conversations"in window&&Conversations.updateThumbnail(Conversations.getCurrentSlideJid()))},
d=void 0;return{pause:function(){d&&(window.clearTimeout(d),d=void 0);a=!1},gracefullyResume:function(){d&&(window.clearTimeout(d),d=void 0);d=setTimeout(function(){a=!0;l()},1E3)},enqueue:function(d){a?d()&&W():b.push(function(){return d()})}}}(),wa={pan:function(a,b){N.panViewboxRelative(w/F*a,t/J*b)},translate:function(a,b){N.translateViewboxRelative(w/F*a,t/J*b)}},fa=function(){var a=function(a){var c=3*k.width,l=3*k.height,d=.1*F,g=.1*J,h=void 0,x=void 0,q=void 0,f=void 0;"width"in a&&(h=a.width,
h>c&&(h=c),h<d&&(h=d));"height"in a&&(x=a.height,x>l&&(x=l),x<g&&(x=g));"x"in a&&(q=a.x,h!=a.width&&(q+=(a.width-h)/2));"y"in a&&x&&(f=a.y,x!=a.height&&(f+=(a.height-x)/2));return{width:h,height:x,x:q,y:f}};return{scale:function(b,c){var l=w*b,d=t*b;c||(d=a({height:d,width:l}),l=d.width,d=d.height);N.scaleAndTranslateViewbox((w-l)/2+E,(t-d)/2+H,l,d)},zoom:function(b,c,l){var d=w*b;b*=t;c||(c=a({height:b,width:d}),d=c.width,b=c.height);d-=w;c=b-t;N.zoomAndPanViewboxRelative(d/2*-1,c/2*-1,d,c,l)},out:function(){fa.zoom(1.2)},
"in":function(){fa.zoom(1/1.2)},constrainRequestedViewbox:a}}(),N=function(){var a=function(a,d,c,h,x,f){isNaN(a)||isNaN(d)||isNaN(c)||isNaN(h)?x&&x():(b&&b.stop(),b=!1,E=a,H=d,w=c,t=h,f||(Y=E,Z=H,aa=w,ba=t),pa(),ha(k),x&&x(),D.call("onViewboxChanged",[a,d,c,h]))},b,c=function(a,d,c,h,f,q,r){if(isNaN(a)||isNaN(d)||isNaN(c)||isNaN(h))f&&f();else{var y=E,u=H,v=w,C=t;r=a-y;var M=d-u,ma=c-v,p=h-C;b&&(b.stop(),b=!1);b=(new TWEEN.Tween({x:0,y:0,w:0,h:0})).to({x:r,y:M,w:ma,h:p},300).easing(TWEEN.Easing.Quadratic.Out).onUpdate(function(){E=
y+this.x;H=u+this.y;w=v+this.w;t=C+this.h}).onComplete(function(){b=!1;q||(Y=E,Z=H,aa=w,ba=t);f&&f();D.call("onViewboxChanged",[a,d,c,h])}).start();var I=function(a){b&&(requestAnimationFrame(I),TWEEN.update(),pa(),ha(k))};requestAnimationFrame(I)}};return{panViewbox:function(a,b,g,h){return c(a,b,w,t,g,h)},translateViewbox:function(b,d,c,h){return a(b,d,w,t,c,h)},zoomAndPanViewbox:function(a,b,g,h,f,k,r){return c(a,b,g,h,f,k,r)},scaleAndTranslateViewbox:function(b,d,c,h,f,k){return a(b,d,c,h,f,k)},
panViewboxRelative:function(a,b,g,h){return c(a+E,b+H,w,t,g,h)},translateViewboxRelative:function(b,c,g,h){return a(b+E,c+H,w,t,g,h)},zoomAndPanViewboxRelative:function(a,b,g,h,f,k){return c(a+E,b+H,g+w,h+t,f,k)},scaleAndTranslateViewboxRelative:function(b,c,g,h,f,k){return a(b+E,c+H,g+w,h+t,f,k)},changeViewbox:a,easeViewbox:c}}(),V=function(){return{up:function(){N.panViewboxRelative(0,-Math.floor(.6*t))},down:function(){N.panViewboxRelative(0,Math.floor(.6*t))},left:function(){N.panViewboxRelative(-Math.floor(.6*
w),0)},right:function(){N.panViewboxRelative(Math.floor(.6*w),0)},shift:N.panViewboxRelative,center:function(a,b,c){N.panViewboxRelative(a-w/2-E,b-t/2-H,c)}}}(),Ua=function(a){try{ja=parseInt(a.jid);Date.now();k=a;k.minX=0;k.minY=0;k.maxX=F;k.maxY=J;$.each(k.inks,function(a,b){qa(b)});Date.now();$.each(k.highlighters,function(a,b){qa(b)});Date.now();$.each(k.texts,function(a,b){ga(b)?ra(b):delete k.texts[b.id]});Date.now();_.each(k.multiWordTexts,function(a,b){var c=f.text.editorFor(a).doc;c.load(a.words);
a.bounds=c.calculateBounds();T(a.bounds)});Date.now();k.width=k.maxX-k.minX;k.height=k.maxY-k.minY;var b=function(){console.log("rendering:",a,k,z);Date.now();D.call("historyReceived",[a]);Date.now();Infinity==k.minX&&(k.minX=0);Infinity==k.minY&&(k.minY=0);Y=k.minX;Z=k.minY;aa=k.width;ba=k.height;ya["default"]();console.log("startRender",Y,Z,aa,ba);pa();ha(k);Date.now();D.call("postRender",[k])};if(0==_.keys(k.images).length)_.defer(b);else{var c=0,l=_.keys(k.images).length;$.each(k.images,function(a,
g){g.bounds=[g.x,g.y,g.x+g.width,g.y+g.height];T(g.bounds);var h=new Image;g.imageData=h;var f=Ja(g,!0);h.onload=function(a){a=!1;0==g.width&&(g.width=h.naturalWidth,a=!0);0==g.height&&(g.height=h.naturalHeight,a=!0);a&&(g.bounds=[g.x,g.y,g.x+g.width,g.y+g.height],T(g.bounds));c+=1;za(g);c>=l&&_.defer(b)};h.onerror=function(a){console.log("Data image load error",g,a);--l;console.log(sprintf("Preloaded %s/%s images",c,l));c>=l&&_.defer(b)};h.src=f})}}catch(d){console.log("receiveHistory exception",
d)}},Va=_.once(function(){return{x:Ra,y:Sa}}),Ka=function(a,b){var c=a,l=b,d=1,g=1,h=Va(),f=h.x,h=h.y;a>f&&(d=f/a,c=a*d);b>h&&(g=h/b,l=b*g);return{width:c,height:l,scaleX:d,scaleY:g}},qa=function(a){if(!ga(a))return a.identity in k.inks&&delete k.inks[a.identity],a.identity in k.highlighters&&delete k.highlighters[a.identity],!1;ia(a);T(a.bounds);var b=$("<canvas />")[0];a.canvas=b;var c=b.getContext("2d"),l=0,d="PRIVATE"==a.privacy.toUpperCase();d&&(l=3);var g=a.bounds[2]-a.bounds[0]+a.thickness+
2*l,h=a.bounds[3]-a.bounds[1]+a.thickness+2*l,f=Ka(g,h);b.width=f.width;b.height=f.height;$(b).css({width:G(g),height:G(h)});b=a.points;g=[];for(h=0;h<b.length;h+=3)g.push(b[h]*f.scaleX),g.push(b[h+1]*f.scaleY),g.push(b[h+2]);var q=-1*(a.minX-a.thickness/2-l)*f.scaleX,r=-1*(a.minY-a.thickness/2-l)*f.scaleY,y,u;if(d){y=g[0]+q;u=g[1]+r;c.lineWidth=a.thickness+l;c.strokeStyle=a.color[0];c.fillStyle=a.color[0];c.moveTo(y,u);c.beginPath();for(h=0;h<g.length;h+=3)c.moveTo(y,u),y=g[h]+q,u=g[h+1]+r,c.lineTo(y,
u);c.lineCap="round";c.stroke();c.closePath();c.strokeStyle="white";c.fillStyle="white"}else c.strokeStyle=a.color[0],c.fillStyle=a.color[0];y=g[0]+q;u=g[1]+r;c.moveTo(y,u);c.beginPath();y=g[0]+q;u=g[1]+r;_.each(_.chunk(g,3),function(b){c.beginPath();c.moveTo(y,u);y=b[0]+q;u=b[1]+r;c.lineTo(y,u);c.lineWidth=b[2]/256*a.thickness;c.lineCap="round";c.stroke()});return!0},La=function(a){a.bounds=[a.x,a.y,a.x+a.width,a.y+a.height]},Ja=function(a){var b="PRIVATE"==a.privacy.toUpperCase()?sprintf("%s%s",
a.slide,a.author):a.slide,c=sprintf,b=btoa(b);return c("/proxyImageUrl/%s?source=%s",b,encodeURIComponent(a.source.trim()))},Aa=function(a){a.bounds=[a.x,a.y,a.x+a.width,a.y+a.runs.length*a.size*1.25]},ia=function(a){for(var b=Infinity,c=Infinity,l=-Infinity,d=-Infinity,g=[],h=a.points,f=0;f<h.length;f+=3){var k=Math.round(h[f]*ka)/ka,r=Math.round(h[f+1]*ka)/ka;h[f]=k;h[f+1]=r;g.push(h[f+2]);b=Math.min(k,b);c=Math.min(r,c);l=Math.max(k,l);d=Math.max(r,d)}a.minX=b;a.minY=c;a.maxX=l;a.maxY=d;a.width=
l-b;a.height=d-c;a.centerX=b+a.width/2;a.centerY=c+a.height/2;a.bounds=[b,c,l,d];a.widths=g},za=function(a){var b=$("<canvas/>")[0];a.canvas=b;b.width=a.width;b.height=a.height;var c=.1*b.width,f=.1*b.height;b.width=a.width+c;b.height=a.height+f;var d=b.getContext("2d");d.drawImage(a.imageData,c/2,f/2,a.width,a.height);"PRIVATE"==a.privacy.toUpperCase()&&(d.globalAlpha=.2,d.fillStyle="red",d.fillRect(0,0,b.width,b.height),d.globalAlpha=1);delete a.imageData},ra=function(a){function b(a){var b=a.font;
"bold"==a.weight&&(b+=" bold");"italic"==a.style&&(b+=" italic");return b}var c=$("<canvas />")[0];a.canvas=c;var f=c.getContext("2d");f.strokeStyle=a.color;f.font=a.font;var d=/\n/;a.width||(a.width=Math.max.apply(Math,a.text.split(d).map(function(a){return f.measureText(a).width})));var g="",h=[],k=!1;$.each(a.text.split(""),function(b,c){c.match(d)?(h.push(""+g),g=""):k&&" "==c?(h.push(g),g=""):(k=f.measureText(g).width>=a.width-80,g+=c)});h.push(g);h=h.map(function(a){return a.trim()});a.runs=
h;Aa(a);var q=a.bounds[3]-a.bounds[1],r=Ka(a.bounds[2]-a.bounds[0],q);c.width=r.width;c.height=r.height;a.height=q;"PRIVATE"==a.privacy.toUpperCase()&&(f.globalAlpha=.2,f.fillStyle="red",f.fillRect(0,0,r.width,r.height),f.globalAlpha=1);f.fillStyle=a.color[0];f.textBaseline="top";$.each(a.runs,function(c,d){var g=function(){var b=_.range(a.size,a.height,a.height/(a.height/(1.25*a.size)));_.each(b,function(b){f.beginPath();f.strokeStyle=a.color[0];b=0+b;f.moveTo(0,b);f.lineTo(0+r.width,b);f.stroke()})},
h=c*a.size*1.25;f.font=b(a);f.fillText(d,0*r.scaleX,(0+h)*r.scaleY,r.width);"underline"==a.decoration&&g()});T(a.bounds)},ha=function(a){if(a){Date.now();try{var b=[E,H,E+w,H+t];ea=[];var c=function(a){void 0!=a&&$.each(a,function(a,c){try{P(c.bounds,b)&&Ma(c)}catch(d){console.log("ink render failed for",d,c.canvas,c.identity,c)}})},l=function(a){a&&$.each(a,function(a,c){c.bounds||(c.bounds=[c.x,c.y,c.x+c.width,c.y+c.height]);P(c.bounds,b)&&f.text.draw(c)})};Object.keys(a.images);pa();Date.now();
$.each(a.images,function(a,c){try{P(c.bounds,b)&&Na(c)}catch(h){console.log("image render failed for",h,c.identity,c)}});Date.now();(function(){c(a.highlighters);Date.now();$.each(a.texts,function(a,c){P(c.bounds,b)&&Oa(c)});Date.now();l(a.multiWordTexts);Date.now();c(a.inks);Date.now();D.call("postRender",[k]);Date.now()})()}catch(d){console.log("Render exception",d)}D.call("onViewboxChanged")}},W=function(){try{ha(k)}catch(a){console.log("exception in render:",a)}},G=function(a){return sprintf("%spx",
a)},pa=function(){z.clearRect(0,0,F,J)},ya=function(){var a=function(a,c,f,d){var g=!1;void 0==a?a=Y:(g=!0,Y=a);void 0==c?c=Z:(g=!0,Z=c);void 0==f?f=aa:(g=!0,aa=f);void 0==d?d=ba:(g=!0,ba=d);d=fa.constrainRequestedViewbox({width:f,height:d,x:a,y:c});f=J/d.height;c=F/d.width;c>f?(a=d.height,f=d.width*c/f):(a=d.height/c*f,f=d.width);N.zoomAndPanViewbox(d.x,d.y,f,a,void 0,!g);D.call("onViewboxChanged")};return{specific:function(b,c,f,d){return a(b,c,f,d)},"default":function(){return a()}}}(),Xa=function(a){if(0<
a.length){a=a.split(" ").map(function(a){return parseFloat(a)});for(var b={thickness:va(f.draw.drawingAttributes.width),color:[f.draw.drawingAttributes.color,255],type:"ink",author:"",timestamp:Date.now(),target:"presentationSpace",privacy:Privacy.getCurrentPrivacy(),slide:ja.toString(),isHighlighter:f.draw.drawingAttributes.isHighlighter},c=[],l,d,g=0;g<a.length;g+=3)l=a[g],d=a[g+1],l=K(l,d),c=c.concat([l.x,l.y,a[g+2]]);b.points=c;b.checksum=b.points.reduce(function(a,b){return a+b},0);b.startingSum=
b.checksum;b.identity=b.checksum.toFixed(1);ia(b);b.isHighlighter?k.highlighters[b.identity]=b:k.inks[b.identity]=b;Wa(b)}},sa=function(){return{type:"moveDelta",identity:Date.now().toString(),author:"",slide:ja.toString(),target:"presentationSpace",privacy:Privacy.getCurrentPrivacy(),timestamp:Date.now(),inkIds:[],textIds:[],multiWordTextIds:[],imageIds:[],xOrigin:0,yOrigin:0,xTranslate:0,yTranslate:0,xScale:1,yScale:1,isDeleted:!1,newPrivacy:"not_set"}},Wa=function(a){updateStrokesPending(1,a.identity);
sendStanza(a)},Ya=function(a){var b=carota.runs.defaultFormatting,c;c=a.color||b.color;"string"==typeof c&&(c=[c,255]);var f=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(c[0]);c={alpha:c[1],red:parseInt(f[1],16),green:parseInt(f[2],16),blue:parseInt(f[3],16)};return{text:a.text,color:c,size:a.size||b.size,font:a.font||b.font,justify:a.align||b.align,bold:!0===a.bold,underline:!0===a.underline,italic:!0===a.italic}},Ba=function(a){if(a.doc){f.text.echoesToDisregard[a.identity]=!0;var b=sendStanza,
c=a.doc.calculateBounds(),k=a.doc.save();a={author:a.author,timestamp:-1,target:a.target,tag:"_",privacy:a.privacy,slide:a.slide,identity:a.identity,type:a.type,x:c[0],y:c[1],requestedWidth:c[2]-c[0],width:c[2]-c[0],height:c[3]-c[1],words:k.map(Ya)};b(a)}},Pa={ink:Za,dirtyInk:$a,move:ab,moveDelta:bb,image:cb,text:db,multiWordText:eb,command:fb,submission:gb,attendance:hb,file:ib},ib=function(a){},hb=function(a){},gb=function(a){Submissions.processSubmission(a)},fb=function(a){if("/TEACHER_VIEW_MOVED"==
a.command&&a.parameters[5]==ja){var b=a.parameters.map(parseFloat);_.some(b,isNaN)?console.log("Can't follow teacher to",a):b[4]!=DeviceConfiguration.getIdentity()&&"Conversations"in window&&Conversations.getIsSyncedToTeacher()}},eb=function(a){a.identity in f.text.echoesToDisregard||ga(a)&&void 0!=A&&A.enqueue(function(){f.text.editorFor(a).doc.load(a.words);W()})},db=function(a){try{ga(a)?(k.texts[a.identity]=a,ra(a),T(a.bounds),void 0!=A&&A.enqueue(function(){return Ca(a.bounds)?(Oa(a),!1):!0})):
a.identity in k.texts&&delete k.texts[a.identity]}catch(b){console.log("textReceived exception:",b)}},bb=function(a){console.log("transformReceived",a);var b="",c=function(){var a=[void 0,void 0,void 0,void 0],b=function(){return a},c=function(b,c){void 0==b||isNaN(b)||(a[c]=b)};return{minX:b[0],setMinX:function(a){c(a,0)},minY:b[1],setMinY:function(a){c(a,1)},maxX:b[2],setMaxX:function(a){c(a,2)},maxY:b[3],setMaxY:function(a){c(a,3)},incorporateBounds:function(b){var c=function(c){var p=a[c];void 0==
p||isNaN(p)?a[c]=b[c]:a[c]=Math.max(p,b[c])},p=function(c){var p=a[c];void 0==p||isNaN(p)?a[c]=b[c]:a[c]=Math.min(p,b[c])};p(0);p(1);c(2);c(3)},getBounds:b,incorporateBoardBounds:function(){void 0!=a[0]&&void 0!=a[1]&&void 0!=a[2]&&void 0!=a[3]&&T(a)}}}();if("not_set"!=a.newPrivacy&&!a.isDeleted){var f=a.newPrivacy,b=b+("Became "+f);$.each(a.inkIds,function(a,b){var c=k.inks[b];c&&(c.privacy=f);if(c=k.highlighters[b])c.privacy=f});$.each(a.imageIds,function(a,b){k.images[b].privacy=f});$.each(a.textIds,
function(a,b){k.texts[b].privacy=f});$.each(a.multiWordTextIds,function(a,b){k.multiWordTextIds[b].privacy=f})}a.isDeleted&&(b+="deleted",f=a.privacy,$.each(a.inkIds,function(a,b){ta("highlighters",f,b);ta("inks",f,b)}),$.each(a.imageIds,function(a,b){var c=f;k.images[b].privacy.toUpperCase()==c.toUpperCase()&&delete k.images[b]}),$.each(a.textIds,function(a,b){var c=f;k.texts[b].privacy.toUpperCase()==c.toUpperCase()&&delete k.texts[b]}),$.each(a.multiWordTextIds,function(a,b){var c=f;k.multiWordTexts[b].privacy.toUpperCase()==
c.toUpperCase()&&delete k.multiWordTexts[b]}));if(1!=a.xScale||1!=a.yScale){var b=b+sprintf("scale (%s,%s)",a.xScale,a.yScale),d=[],g=[],h=[],x=[];$.each(a.inkIds,function(a,b){d.push(k.inks[b]);d.push(k.highlighters[b])});$.each(a.imageIds,function(a,b){x.push(k.images[b])});$.each(a.textIds,function(a,b){g.push(k.texts[b])});$.each(a.multiWordTextIds,function(a,b){h.push(k.multiWordTexts[b])});var q=0,r=0;if("xOrigin"in a&&"yOrigin"in a)q=a.xOrigin,r=a.yOrigin;else{var y=!0,u=function(a){y?(q=a.x,
r=a.y,y=!1):(a.x<q&&(q=a.x),a.y<r&&(r=a.y))};$.each(d,function(a,b){void 0!=b&&"bounds"in b&&1<_.size(b.bounds)&&u({x:b.bounds[0],y:b.bounds[1]})});$.each(g,function(a,b){void 0!=b&&"x"in b&&"y"in b&&u({x:b.x,y:b.y})});$.each(h,function(a,b){void 0!=b&&"x"in b&&"y"in b&&u({x:b.x,y:b.y})});$.each(x,function(a,b){void 0!=b&&"x"in b&&"y"in b&&u({x:b.x,y:b.y})})}c.setMinX(q);c.setMinY(r);$.each(d,function(b,d){if(d&&void 0!=d){var f=d.points,g=d.bounds[0],h=d.bounds[1],k,l,x=g-q;k=h-r;for(var x=-(x-x*
a.xScale),Ta=-(k-k*a.yScale),y=0;y<f.length;y+=3)k=f[y]-g,l=f[y+1]-h,f[y]=g+k*a.xScale+x,f[y+1]=h+l*a.yScale+Ta;ia(d);c.incorporateBounds(d.bounds)}});$.each(x,function(b,d){if(void 0!=d){d.width*=a.xScale;d.height*=a.yScale;var f=d.x-q,g=d.y-r,g=-(g-g*a.yScale);d.x+=-(f-f*a.xScale);d.y+=g;La(d);c.incorporateBounds(d.bounds)}});$.each(g,function(b,d){if(void 0!=d){d.width*=a.xScale;d.height*=a.yScale;var f=d.x-q,g=d.y-r,g=-(g-g*a.yScale);d.x+=-(f-f*a.xScale);d.y+=g;d.size*=a.yScale;d.font=sprintf("%spx %s",
d.size,d.family);ga(d)?(ra(d),Aa(d)):d.identity in k.texts&&delete k.texts[d.identity];c.incorporateBounds(d.bounds)}});$.each(h,function(b,d){if(void 0!=d){d.width*=a.xScale;d.height*=a.yScale;var f=d.x-q,g=d.y-r,g=-(g-g*a.yScale);d.x+=-(f-f*a.xScale);d.y+=g;d.size*=a.yScale;d.font=sprintf("%spx %s",d.size,d.family);d.identity in k.multiWordTexts&&delete k.multiWordTexts[d.identity];c.incorporateBounds(d.bounds)}})}if(a.xTranslate||a.yTranslate){var v=a.xTranslate,C=a.yTranslate,b=b+sprintf("translate (%s,%s)",
v,C),M=function(a){if(a){for(var b=a.points,d=0;d<b.length;d+=3)b[d]+=v,b[d+1]+=C;ia(a);c.incorporateBounds(a.bounds)}};$.each(a.inkIds,function(a,b){M(k.inks[b]);M(k.highlighters[b])});$.each(a.imageIds,function(b,d){var f=k.images[d];f.x+=a.xTranslate;f.y+=a.yTranslate;La(f);c.incorporateBounds(f.bounds)});$.each(a.textIds,function(b,d){var f=k.texts[d];f.x+=a.xTranslate;f.y+=a.yTranslate;Aa(f);c.incorporateBounds(f.bounds)});$.each(a.multiWordTextIds,function(b,d){var f=k.multiWordTexts[d],g=f.doc;
g.position.x+=a.xTranslate;g.position.y+=a.yTranslate;f.bounds=g.calculateBounds();c.incorporateBounds(f.bounds)})}c.incorporateBoardBounds();updateStatus(sprintf("%s %s %s %s %s",b,a.imageIds.length,a.textIds.length,a.multiWordTextIds.length,a.inkIds.length));W()},ab=function(a){updateStatus(sprintf("Moving %s, %s, %s",Object.keys(a.images).length,Object.keys(a.texts).length,Object.keys(a.inks).length));$.each(a.inks,function(a,c){k.inks[a]=c});$.each(a.images,function(a,c){k.images[a]=c});$.each(a.texts,
function(a,c){k.texts[a]=c});$.each(a.multiWordTexts,function(a,c){k.multiWordTexts[a]=c});W()},ta=function(a,b,c){c in k[a]&&k[a][c].privacy.toUpperCase()==b.toUpperCase()&&delete k[a][c]},$a=function(a){var b=a.identity;a=a.privacy;ta("highlighters",a,b);ta("inks",a,b);updateStatus(sprintf("Deleted ink %s",b));W()},Ca=function(a){return!_.some(ea,function(b){return P(b,a)})},Da=function(a){var b=O(a[0],a[1]);a=O(a[2],a[3]);return{screenPos:b,screenLimit:a,screenWidth:a.x-b.x,screenHeight:a.y-b.y}},
Na=function(a){try{if(void 0!=a.canvas){var b=Da(a.bounds);ea.push(a.bounds);var c=.1*b.screenWidth,f=.1*b.screenHeight;z.drawImage(a.canvas,b.screenPos.x-c/2,b.screenPos.y-f/2,b.screenWidth+c,b.screenHeight+f)}}catch(d){console.log("drawImage exception",d)}},Oa=function(a){try{var b=Da(a.bounds);ea.push(a.bounds);z.drawImage(a.canvas,b.screenPos.x,b.screenPos.y,b.screenWidth,b.screenHeight)}catch(c){console.log("drawText exception",c)}},Ma=function(a){var b=Da(a.bounds);ea.push(a.bounds);z.drawImage(a.canvas,
b.screenPos.x,b.screenPos.y,b.screenWidth,b.screenHeight)},cb=function(a){var b=new Image;a.imageData=b;b.onload=function(){0==a.width&&(a.width=b.naturalWidth);0==a.height&&(a.height=b.naturalHeight);a.bounds=[a.x,a.y,a.x+a.width,a.y+a.height];T(a.bounds);k.images[a.identity]=a;updateTracking(a.identity);za(a);void 0!=A&&A.enqueue(function(){if(Ca(a.bounds)){try{Na(a)}catch(b){console.log("drawImage exception",b)}return!1}console.log("Rerendering image in contested space");return!0})};b.src=Ja(a)},
Za=function(a){ia(a);updateStrokesPending(-1,a.identity);qa(a)&&(T(a.bounds),a.isHighlighter?k.highlighters[a.identity]=a:k.inks[a.identity]=a,void 0!=A&&A.enqueue(function(){return Ca(a.bounds)?(Ma(a),!1):!0}))},L=function(){delete D.onBoardContentChanged.autoZooming},U={historyReceived:function(a){Ua(a)},stanzaReceived:function(a){try{a.type in Pa?(Pa[a.type](a),D.call("onBoardContentChanged")):console.log(sprintf("Unknown stanza: %s %s",a.type,a))}catch(b){console.log("Exception in receiveMeTLStanza",
b,a)}},progress:D,getCanvas:function(){return B},requestViewbox:function(a,b,c,f,d){N.changeViewbox(a,b,c,f,d)},resizeCanvas:function(a,b){var c=Math.round(a),f=Math.round(b),d=B[0].width,g=B[0].height;if(g!=f||d!=c)F=c,J=f,B.width=c,B.height=f,B[0].width=c,B[0].height=f,console.log("resizing canvas:",d,c,g,f,z),W()},worldToScreen:O,screenToWorld:K,scale:function(){return Math.min(F/w,J/t)},alertCanvas:function(a){var b=B[0],c=b.toDataURL();window.open(c,a,sprintf("width=%s, height=%s",b.width,b.height))},
getModes:function(){return f}},f=function(a){var b=function(){$(".activeTool").removeClass("activeTool");$(".activeMode").addClass("inactiveMode").removeClass("activeMode")},c=function(a,c){b();$(a).addClass("activeMode").removeClass("inactiveMode");$(".activeTool").removeClass("activeTool").addClass("inactiveTool");$(c).addClass("activeTool").removeClass("inactiveTool")},l={name:"none",activate:function(){f.currentMode.deactivate();f.currentMode=f.none;b()},deactivate:function(){b();Q(B)}};return{currentMode:l,
none:l,text:function(){var d=function(){},g,h,l,q,r,y,u,v,C,M,w,p,I,t=function(a){return f.text.editorFor({bounds:[a.x,a.y,a.x,a.y],identity:sprintf("%s_%s_%s","",Date.now(),_.uniqueId()),requestedWidth:300,width:0,height:0,x:a.x,y:a.y,type:"multiWordText",author:"",words:[]})};$(function(){g=$("#fontFamilySelector");h=$("#fontSizeSelector");l=$("#fontColorSelector");q=$("#fontBoldSelector");r=$("#fontItalicSelector");y=$("#fontUnderlineSelector");u=$("#justifySelector");v=$("#presetFitToText");C=
$("#presetRunToEdge");M=$("#presetNarrow");w=$("#presetWiden");I=$("#presetFullscreen");p=$("#presetCenterOnScreen");var a=g.find(".fontFamilyOption").clone(),b=h.find(".fontSizeOption").clone(),c=l.find(".fontColorOption").clone();Fa.getAllFamilies().map(function(b){g.append(a.clone().attr("value",b).text(b))});Fa.getAllSizes().map(function(a){h.append(b.clone().attr("value",a).text(a))});Ea.getAllNamedColors().map(function(a){l.append(c.clone().attr("value",a.rgb).text(a.name))});var d=function(a){return function(){_.each(k.multiWordTexts,
function(b){if(b.doc.isActive){var c=b.doc.selectedRange();c.setFormatting(a,!0!==c.getFormatting()[a]);0<b.doc.save().length&&Ba(b)}})}},f=function(a){return function(){var b=$(this).val();_.each(k.multiWordTexts,function(c){c.doc.isActive&&(c.doc.selectedRange().setFormatting(a,b),0<c.doc.save().length&&Ba(c))})}},ca=function(a){return function(){_.each(k.multiWordTexts,function(b){if(b.doc.isActive){switch(a){case "runToEdge":var c=K(F,0);b.doc.width(c.x+E-b.x);break;case "fitToText":b.doc.width(b.doc.frame.actualWidth());
break;case "widen":b.doc.width(1.6*b.doc.frame.actualWidth());break;case "narrow":b.doc.width(.6*b.doc.frame.actualWidth());break;case "centerOnScreen":b.doc.width(K(F,0).x);b.doc.selectedRange().setFormatting("align","center");b.doc.position.x=E;break;case "fullscreen":b.doc.position.x=E,b.doc.position.y=H,b.doc.width(K(F,0).x),b.doc.select(0,b.doc.frame.length-1),b.doc.selectedRange().setFormatting("align","center"),b.doc.selectedRange().setFormatting("bold",!0),c=b.doc.documentRange().save(),c.push({text:"\n"}),
c.push({text:"\n"}),b.doc.load(c),c=b.doc.frame.length-1,b.doc.select(c,c)}b.doc.contentChanged.fire()}})}};q.click(d("bold"));r.click(d("italic"));y.click(d("underline"));g.change(f("font"));h.change(f("size"));l.change(f("color"));u.change(f("align"));v.click(ca("fitToText"));C.click(ca("runToEdge"));M.click(ca("narrow"));w.click(ca("widen"));p.click(ca("centerOnScreen"));I.click(ca("fullscreen"))});return{echoesToDisregard:{},editorFor:function(a){var b=k.multiWordTexts[a.identity];b||(b=k.multiWordTexts[a.identity]=
a);if(!b.doc){var c=""==a.author;b.doc=carota.editor.create($("<div />",{id:sprintf("t_%s",a.identity)}).appendTo(Qa)[0],B[0],c?function(){ha(k)}:d);c&&(b.doc.contentChanged(function(){var a=k.multiWordTexts[b.identity];a.privacy=Privacy.getCurrentPrivacy();a.target="presentationSpace";a.slide=Conversations.getCurrentSlideJid();0<b.doc.save().length&&Ba(a)}),b.doc.selectionChanged(function(a){a=a();q.toggleClass("active",1==a.bold);r.toggleClass("active",1==a.italic);y.toggleClass("active",1==a.underline);
h.val(a.size||carota.runs.defaultFormatting.size);g.val(a.font||carota.runs.defaultFormatting.font);l.val(a.color||carota.runs.defaultFormatting.color);u.val(a.align||carota.runs.defaultFormatting.align)}))}b.doc.position={x:a.x,y:a.y};b.doc.width(a.requestedWidth);return b},draw:function(b){b&&b.doc&&carota.editor.paint(B[0],b.doc,!0,a)},activate:function(){f.currentMode.deactivate();f.currentMode=f.text;c("#textTools","#insertText");$(".activeBrush").removeClass("activeBrush");D.call("onLayoutUpdated");
var a=Date.now();S(B,d,d,function(b,c,d,g){var h=[g.x-10,g.y-10,g.x+10,g.y+10];b=_.values(k.multiWordTexts).filter(function(a){var b=a.doc.calculateBounds();return P(b,h)&&""==a.author});_.each(k.multiWordTexts,function(a){a.doc.isActive=!1;0==a.doc.save().length&&delete k.multiWordTexts[a.identity]});console.log("Selected texts",b);0<b.length?(b=b[0].doc,b.isActive=!0,c=g.x-b.position.x,d=g.y-b.position.y,g=Date.now(),c=b.byCoordinate(c,d),b.mouseupHandler(c),500>=g-a&&b.dblclickHandler(c),a=g):
(g=t(g).doc,g.load([]),g.isActive=!0,g.mouseupHandler(g.byOrdinal(0)));D.historyReceived.ClearMultiTextEchoes=function(){f.text.echoesToDisregard={}};D.call("onSelectionChanged",[f.select.selected])})},deactivate:function(){b();_.each(k.multiWordTexts,function(a){a.doc.isActive=!1});Q(B);W()}}}(),image:function(){var a=void 0,g=function(){},h={},k=void 0,q=void 0,r=void 0,l=void 0,u=void 0,v=void 0,C=void 0,M=void 0,z=void 0,p=void 0,I=void 0,da=[{name:"160*120",func:function(a,b){return{w:160,h:120}}},
{name:"320*240",func:function(a,b){return{w:320,h:240}}},{name:"25%",func:function(a,b){return{w:a/4,h:b/4}}},{name:"50%",func:function(a,b){return{w:a/2,h:b/2}}},{name:"75%",func:function(a,b){return{w:a/4*3,h:b/4*3}}},{name:"Native",func:function(a,b){return{w:a,h:b}}}],X=function(){if("type"in h&&"imageDefinition"==h.type){k.css({position:"absolute",left:G(h.screenX-30),top:G(h.screenY)});if("fileUpload"in h){r.hide();l.show();$.map(u.find(".imageSizeChoice"),function(a){"thumbnailSize"in h&&h.thumbnailSize.name==
$(a).text()?$(a).addClass("active"):$(a).removeClass("active")});var a=new FileReader;a.onload=function(a){"thumbnailSize"in h||(h.thumbnailSize=da[0]);v[0].getContext("2d").clearRect(0,0,v.width(),v.height());var b=new Image;b.onload=function(a){var c=h.thumbnailSize.func(b.width,b.height);a=c.w;var c=c.h,d,f;a<c?(d=300,f=a/(c/300)):(f=300,d=c/(a/300));v.attr("width",f);v.attr("height",d);v.css({width:G(f),height:G(d)});v[0].getContext("2d").drawImage(b,0,0,f,d);M.text(h.x);z.text(h.y);p.text(a);
I.text(c);d=$("<canvas/>");d.attr("width",a);d.attr("height",c);d.css({width:G(a),height:G(c)});d[0].getContext("2d").drawImage(b,0,0,a,c);h.width=a;h.height=c;h.resizedImage=d[0].toDataURL();"resizedImage"in h&&C.show()};b.src=a.target.result};a.readAsDataURL(h.fileUpload);"resizedImage"in h?C.show():C.hide()}else r.show(),l.hide();k.show()}else R()},R=function(){k.hide();var a=r.wrap("<form>").closest("form").get(0);void 0!=a&&a.reset();void 0!=v[0]&&v[0].getContext("2d").clearRect(0,0,v.width(),
v.height());M.text("");z.text("");p.text("");I.text("");r.unwrap();h={};C.text("Upload").unbind("click").on("click",F)},F=function(){C.unbind("click").text("Uploading");if("type"in h&&"imageDefinition"==h.type&&"resizedImage"in h){A.pause();var a=Date.now(),b=sprintf("%s%s","",a),c=Conversations.getCurrentSlideJid(),d=sprintf("/uploadDataUri?jid=%s&filename=%s",c.toString(),encodeURI(b));$.ajax({url:d,type:"POST",success:function(d){updateTracking(b);var f=$(d).find("resourceUrl").text(),g={type:"image",
author:"",timestamp:a,tag:'{"author":"","privacy":"'+Privacy.getCurrentPrivacy()+'","id":"'+f+'","isBackground":false,"zIndex":0,"timestamp":-1}',identity:f,slide:c.toString(),source:$(d).text(),width:h.width,height:h.height,target:"presentationSpace",privacy:Privacy.getCurrentPrivacy(),x:h.x,y:h.y};R();updateTracking(f,function(){ya.specific(Math.min(g.x,E),Math.min(g.y,H),Math.max(g.x+g.width,w),Math.max(g.y+g.height,t))});sendStanza(g);A.gracefullyResume()},error:function(a){R();alert("Upload failed.  This image cannot be processed, either because of image protocol issues or because it exceeds the maximum image size.");
A.gracefullyResume()},data:h.resizedImage,cache:!1,contentType:!1,processData:!1})}},Ha=!1;$(function(){if(!Ha){Ha=!0;a=$("imageMarquee");k=$("#imageInsertOptions");q=$("#imageInsertOptionsClose");r=$("#imageFileChoice");l=$("#imageSizeControls");u=$("#imageSizeChoiceSelector");v=$("#imageUploadThumbnail");$("#imageProgressContainer");C=$("#imageUploadButton");M=$("#imageUploadX");z=$("#imageUploadY");p=$("#imageUploadWidth");I=$("#imageUploadHeight");q.on("click",R);r.attr("accept","image/*");void 0!=
r[0]&&r[0].addEventListener("change",function(a){"type"in h&&"imageDefinition"==h.type&&(a=(a.target.files||a.dataTransfer.files)[0],0==a.type.indexOf("image")&&(h.fileUpload=a,h.thumbnailSize=da[0],X()))},!1);var b=u.find(".imageSizeChoice").clone();u.empty();da.map(function(a){var c=b.clone().text(a.name).on("click",function(){"type"in h&&"imageDefinition"==h.type&&(h.thumbnailSize=a,X())});u.append(c)});R()}});return{activate:function(){f.currentMode.deactivate();f.currentMode=f.image;c("#imageTools",
"#insertImage");R();D.call("onLayoutUpdated");S(B,g,g,function(b,c,f,g){a.show();a.css({left:G(b),top:G(c)});R();b=O(g.x,g.y);h={type:"imageDefinition",screenX:b.x,screenY:b.y,x:g.x,y:g.y};X()})},deactivate:function(){R();Q(B);b()}}}(),pan:{name:"pan",activate:function(){updateStatus("PAN");f.currentMode.deactivate();c("#panTools","#panMode");f.currentMode=f.pan;var a,b;S(B,function(c,f,k){L();a=c;b=f},function(c,f,k){wa.translate(-1*(c-a),-1*(f-b));a=c;b=f},function(a,b,c){})},deactivate:function(){b();
Q(B)}},select:function(){var a=!1,g=function(){f.select.selected={images:{},text:{},inks:{},multiWordTexts:{}};D.call("onSelectionChanged",[f.select.selected])},h=_.debounce(function(){_.forEach(["images","texts","inks","highlighters","multiWordTexts"],function(a){var b="highlighters"==a?"inks":a;if(f&&f.select&&f.select.selected&&b in f.select.selected){var c=f.select.selected[b];_.forEach(c,function(d){c&&a in k&&d.identity in k[a]?c[d.identity]=k[a][d.identity]:"inks"==b?"highlighters"==a&&d.identity in
c&&1==c[d.identity].isHighlighter?delete c[d.identity]:"inks"==a&&d.identity in c&&0==c[d.identity].isHighlighter&&delete c[d.identity]:delete c[d.identity]})}});D.call("onSelectionChanged",[f.select.selected])},100),l=function(){if(void 0!=f.select.selected&&a){var b=f.select.selected;banContent(Conversations.getCurrentConversationJid(),Conversations.getCurrentSlideJid(),_.uniq(_.map(b.inks,function(a){return a.identity})),_.uniq(_.map(b.texts,function(a){return a.identity})),_.uniq(_.map(b.multiWordTexts,
function(a){return a.identity})),_.uniq(_.map(b.images,function(a){return a.identity})))}g()},q=function(){(a=Conversations.shouldModifyConversation()?!a:!1)?$("#administerContent").removeClass("disabledButton"):$("#administerContent").addClass("disabledButton");g()};D.onBoardContentChanged.ModesSelect=h;D.onViewboxChanged.ModesSelect=h;D.onSelectionChanged.ModesSelect=function(b){b&&(f.select.selected=b,"images"in b&&0<_.size(b.images)||"inks"in b&&0<_.size(b.inks)||"texts"in b&&0<_.size(b.texts)||
"multiWordTexts"in b&&0<_.size(b.multiWordTexts)?($("#delete").removeClass("disabledButton"),$("#resize").removeClass("disabledButton"),a?$("#ban").removeClass("disabledButton"):$("#ban").addClass("disabledButton")):($("#delete").addClass("disabledButton"),$("#resize").addClass("disabledButton"),$("#ban").addClass("disabledButton")),"Conversations"in window&&Conversations.shouldModifyConversation()?($("#ban").show(),$("#administerContent").show()):($("#ban").hide(),$("#administerContent").hide()),
a?$("#administerContent").removeClass("disabledButton"):$("#administerContent").addClass("disabledButton"),f.currentMode==f.select&&($("#selectionAdorner").empty(),_.forEach(["images","texts","inks","highlighters","multiWordTexts"],function(a){a in b&&$.each(b[a],function(a,b){var c=xa(O(b.bounds[0],b.bounds[1])),d=xa(O(b.bounds[2],b.bounds[3])),f=d.x-c.x,d=d.y-c.y;xa(b.bounds[0],b.bounds[1],b.bounds[2],b.bounds[3]);$("#selectionAdorner").prepend($("<div />").addClass("selectionAdorner").css({left:c.x,
top:c.y,width:f,height:d}).data("originalWidth",f).data("originalHeight",d))})})))};D.historyReceived.ModesSelect=g;D.conversationDetailsReceived.ModesSelect=function(b){a&&Conversations.shouldModifyConversation()&&(a=!1);Conversations.shouldModifyConversation()?($("#ban").show(),$("#administerContent").show(),$("#administerContent").bind("click",q),$("#ban").bind("click",l)):($("#ban").hide(),$("#administerContent").hide(),$("#administerContent").unbind("click"),$("#ban").unbind("click"));a?$("#administerContent").removeClass("disabledButton"):
$("#administerContent").addClass("disabledButton")};return{name:"select",selected:{images:{},texts:{},inks:{},multiWordTexts:{}},clearSelection:g,activate:function(){f.currentMode.deactivate();f.currentMode=f.select;c("#selectTools","#selectMode");updateStatus("SELECT");var b={x:0,y:0},h,u,v,C=$("<div/>",{id:"selectMarquee"}),w=$("#selectionAdorner"),t=!1,p=!1;$("#delete").bind("click",function(){if(void 0!=f.select.selected){var a=sa();a.isDeleted=!0;"inks"in f.select.selected&&(a.inkIds=_.keys(f.select.selected.inks));
"texts"in f.select.selected&&(a.textIds=_.keys(f.select.selected.texts));"images"in f.select.selected&&(a.imageIds=_.keys(f.select.selected.images));"multiWordTexts"in f.select.selected&&(a.multiWordTextIds=_.keys(f.select.selected.multiWordTexts));sendStanza(a)}g()});var I=[0,0,0,0];$("#administerContent").bind("click",q);$("#ban").bind("click",l);$("#resize").bind("click",function(){var a=_.flatten([_.values(f.select.selected.images),_.values(f.select.selected.texts),_.values(f.select.selected.inks),
_.values(f.select.selected.multiWordTexts)]);if(0<a.length){var b=Math.min.apply(Math,a.map(function(a){return a.bounds[0]})),c=Math.min.apply(Math,a.map(function(a){return a.bounds[1]})),d=Math.max.apply(Math,a.map(function(a){return a.bounds[2]})),a=Math.max.apply(Math,a.map(function(a){return a.bounds[3]})),b=O(b,c),d=O(d,a).x,b=b.y;I=[d-30,b-30,d+30,b+30];w.append($("<img />",{src:"/static/images/resize.png","class":"resizeHandle"}).css({width:G(30),height:G(30),position:"absolute",left:G(d),
top:G(b)}))}});var z=function(a){a("images");a("texts");a("multiWordTexts");a("inks")},p=t=!1;S(B,function(a,c,d,g,k){t=p=!1;b={x:a,y:c};h=a;u=c;var l=[g.x-10,g.y-10,g.x+10,g.y+10];P(I,[a-10,c-10,a+10,c+10])?(updateStatus("Resizing"),p=!0):k.ctrl||(t=_.some(["images","texts","inks","multiWordTexts"],function(a){return _.some(f.select.selected[a],function(a){return a?P(a.bounds,l):!1})}));v=g;t?updateStatus("SELECT -> DRAG"):p?updateStatus("SELECT -> RESIZE"):(w.empty(),w.append(C),C.show(),oa(C,b,
b))},function(a,c,d,f,g){d={x:a,y:c};var k=a-h,l=c-u;h=a;u=c;if(p){var q=a/I[0],x=q;g.ctrl&&(x=c/I[0]);updateStatus(sprintf("Resizing %s%%",100*q));$(".selectionAdorner").map(function(){var a=$(this);a.css({width:a.data("originalWidth")*q,height:a.data("originalHeight")*x})})}else t?$(".selectionAdorner").map(function(){var a=$(this),b=G(parseInt(a.css("left"))+k),c=G(parseInt(a.css("top"))+l);a.css({left:b,top:c})}):oa(C,b,d)},function(b,c,g,h,l){A.gracefullyResume();if(t)l=sa(),l.xTranslate=h.x-
v.x,l.yTranslate=h.y-v.y,l.inkIds=_.keys(f.select.selected.inks),l.textIds=_.keys(f.select.selected.texts),l.imageIds=_.keys(f.select.selected.images),l.multiWordTextIds=_.keys(f.select.selected.multiWordTexts),t=!1,sendStanza(l);else if(p){h=sa();b/=I[0];var q=Infinity,x=Infinity;_.forEach(f.select.selected.inks,function(a){q=Math.min(a.bounds[0]);x=Math.min(a.bounds[1])});_.forEach(f.select.selected.texts,function(a){q=Math.min(a.bounds[0]);x=Math.min(a.bounds[1])});_.forEach(f.select.selected.images,
function(a){q=Math.min(a.bounds[0]);x=Math.min(a.bounds[1])});_.forEach(f.select.selected.multiWordTexts,function(a){q=Math.min(a.bounds[0]);x=Math.min(a.bounds[1])});h.xOrigin=q;h.yOrigin=x;h.inkIds=_.keys(f.select.selected.inks);h.textIds=_.keys(f.select.selected.texts);h.imageIds=_.keys(f.select.selected.images);h.multiWordTextIds=_.keys(f.select.selected.multiWordTexts);h.xScale=b;h.yScale=l.ctrl?c/I[0]:b;sendStanza(h);p=!1}else{c=na(v,h);var r=[c.left,c.top,c.right,c.bottom],y={images:{},texts:{},
inks:{},multiWordTexts:{}},u={};z(function(b){$.each(k[b],function(c,f){if(!("bounds"in f)&&"type"in f)switch(f.type){case "text":ra(f);break;case "image":za(f);break;case "ink":qa(f);break;default:f.bounds=[NaN,NaN,NaN,NaN]}var g=f.bounds,g=Math.abs(.5*(g[2]-g[0])*(g[3]-g[1])),h;h=f.bounds;h=P(r,h)?(Math.max(r[0],h[0])-Math.min(r[2],h[2]))*(Math.max(r[1],h[1])-Math.min(r[3],h[3])):0;h>=g&&(incrementKey(u,f.author),a?""!=f.author&&(y[b][f.identity]=f):""==f.author&&(y[b][f.identity]=f))})});$.each(k.highlighters,
function(b,c){P(c.bounds,r)&&(incrementKey(u,c.author),a?""!=c.author&&(y.inks[c.identity]=c):""==c.author&&(y.inks[c.identity]=c))});l.ctrl?z(function(a){$.each(y[a],function(b,c){b in f.select.selected[a]?delete f.select.selected[a][b]:f.select.selected[a][b]=c})}):f.select.selected=y;var w=sprintf("Selected %s images, %s texts, %s inks, %s rich texts ",_.keys(f.select.selected.images).length,_.keys(f.select.selected.texts).length,_.keys(f.select.selected.inks).length);$.each(u,function(a,b){w+=
sprintf("%s:%s ",a,b)});updateStatus(w)}D.call("onSelectionChanged",[f.select.selected]);C.css({width:0,height:0}).hide()})},deactivate:function(){Q(B);b();g();$("#delete").unbind("click");$("#resize").unbind("click");$("#selectionAdorner").empty();$("#selectMarquee").hide();$("#administerContent").unbind("click");$("#ban").unbind("click")}}}(),zoom:{name:"zoom",activate:function(){f.currentMode.deactivate();f.currentMode=f.zoom;c("#zoomTools","#zoomMode");var a=$("<div />",{id:"zoomMarquee"}),b,
h={x:0,y:0};S(B,function(c,f,k,l){L();b=l;a.show();a.appendTo($("#selectionAdorner"));h={x:c,y:f};oa(a,h,h)},function(b,c,f,g){b={x:b,y:c};c=na(b,h);f="left";g="top";b.x==c.left&&(f="right");b.y==c.top&&(g="bottom");b=Ia(c,f,g);oa(a,{x:b.right,y:b.bottom},{x:b.left,y:b.top})},function(c,f,h,k){A.gracefullyResume();a.hide();c={x:0+k.x,y:0+k.y};f=na(c,{x:0+b.x,y:0+b.y});h="left";k="top";c.x==f.left&&(h="right");c.y==f.top&&(k="bottom");c=Ia(f,h,k);ya.specific(c.left,c.top,c.width,c.height)})},deactivate:function(){b();
$("#zoomMarquee").remove();Q(B)}},feedback:function(){var a=function(){switch(currentBackstage){case "quizzes":$("#quizzesButton").addClass(active);break;case "submissions":$("#submissionButton").addClass(active)}};D.onConversationJoin.setConversationRole=function(){a()};D.conversationDetailsReceived.respectNewPermissions=a;return{name:"feedback",activate:function(){f.currentMode.deactivate();f.currentMode=f.feedback;a();c("#feedbackTools","#feedbackMode");S(B,function(a,b,c,d){},function(a,b,c,d){},
function(a,b,c,d){});a()},deactivate:function(){b();Q(B);D.call("onLayoutUpdated")}}}(),draw:function(){var a=Ga.getDefaultBrushes(),g,h=!1,l=!1;return{name:"draw",brushes:_.map(a,function(a){return _.clone(a)}),activate:function(){if(f.currentMode!=f.draw){f.currentMode.deactivate();f.currentMode=f.draw;var b=function(){},r=void 0,y=void 0,u=function(a){f.draw.brushes[a.index]=a};$(".activeBrush").removeClass("activeBrush");var v=function(){var a=$("#drawTools");_.each(a.find(".pen"),function(a,
c){var d=f.draw.brushes[c],k=$(a).css({color:d.color}).click(function(){$(".activeBrush").removeClass("activeBrush");$(this).addClass("activeBrush");g=d;u(d);f.draw.drawingAttributes=g;h=!1;b(d)});k.find(".widthIndicator").text(d.width);d==g&&k.addClass("activeBrush")})},b=function(a){var c=$("#colors .dots"),d=$("#sizes .dots"),f=Ea.getAllNamedColors(),h=Ga.getAllBrushSizes();d.empty();h.map(function(c){var f=r.clone();d.append(f);f.click(function(){a.width=c;u(a);g=a;v();b(a)});var h=Canvas.circle(a.color,
c,50);c==a.width&&f.addClass("activeTool");f.prepend(h);h=c.toString()+"px";f.find(".sizeDotName").append(h)});c.empty();f.map(function(d){var f=y.clone();c.append(f);f.on("click",function(){a.color=d.rgb;g=a;u(a);v();b(a)});f.css("color",d.rgb);"rgb"in d&&d.rgb==a.color&&f.addClass("activeTool");var h=d.name;f.find(".colorDotName").append(h)});f=$("#setPenToHighlighter").unbind("click").on("click",function(){a.isHighlighter=!0;g=a;u(a);v();b(a)});h=$("#setPenToPen").unbind("click").on("click",function(){a.isHighlighter=
!1;g=a;u(a);v();b(a)});"isHighlighter"in g&&g.isHighlighter?(f.addClass("activeTool").addClass("active"),h.removeClass("activeTool").removeClass("active")):(h.addClass("activeTool").addClass("active"),f.removeClass("activeTool").removeClass("active"));D.call("onLayoutUpdated")};$("#resetPenButton").empty().text("reset pen").click(function(){var c=_.find(a,function(a){return a.id==g.id});void 0!=c&&(g.width=c.width,g.color=c.color,g.isHighlighter=c.isHighlighter,v(),b(g))});if(!l){l=!0;r=$("#penSize .sizeDot").clone();
y=$("#penColor .colorDot").clone();g=f.draw.brushes[0];v();b(g);f.draw.drawingAttributes=g;var w=$("#drawTools");w.find(".eraser").click(function(a){$(".activeBrush").removeClass("activeBrush");$(this).addClass("activeBrush");h=!0});w.find(".advancedTools").on("click",function(){b(g);showBackstage("customizeBrush")})}c("#drawTools","#drawMode");var t=[],A=[];$(".activeBrush").removeClass("activeBrush");h?$("#drawTools").find(".eraser").addClass("activeBrush"):_.each($("#drawTools").find(".pen"),function(a,
b){b+1==g.id&&$(a).addClass("activeBrush")});S(B,function(a,b,c,d,g){A=[];h||g.eraser||(z.strokeStyle=f.draw.drawingAttributes.color,t=[a,b,256*c])},function(a,b,c,d,g){if(h||g.eraser){var l=[d.x-10,d.y-10,d.x+10,d.y+10];a=function(a){$.each(a,function(b,c){if(""==c.author&&P(c.bounds,l)){delete a[c.identity];A.push(c.identity);var d=c.bounds,f=O(d[0],d[1]),d=O(d[2],d[3]);z.fillRect(f.x,f.y,d.x-f.x,d.y-f.y)}})};z.globalAlpha=.4;z.fillStyle="red";a(k.inks);a(k.highlighters);z.globalAlpha=1}else d=
f.draw.drawingAttributes.width*c,z.beginPath(),z.lineCap="round",z.lineWidth=d,d=_.takeRight(t,3),z.moveTo(d[0],d[1]),z.lineTo(a,b),z.stroke(),t=t.concat([a,b,256*c])},function(a,b,c,d,g){h||g.eraser?(a=sa(),a.isDeleted=!0,a.inkIds=A,sendStanza(a)):(d=f.draw.drawingAttributes.width*c,z.lineWidth=d,z.beginPath(),z.lineWidth=d,z.lineCap="round",d=_.takeRight(t,3),z.moveTo(d[0],d[1]),z.lineTo(a,b),z.stroke(),t=t.concat([a,b,256*c]),Xa(t.join(" ")))})}},deactivate:function(){$(".activeBrush").removeClass("activeBrush");
b();A.gracefullyResume();Q(B);"customizeBrushPopup"==window.currentBackstage&&window.hideBackstage()}}}(),erase:{activate:function(){f.currentMode.deactivate();f.currentMode=f.erase;S(B,function(a,b,c,f){},function(a,b,c,f){},function(a,b,c,f){})},deactivate:function(){Q(B)}},message:function(){var a=!1,g=void 0,h=void 0,k=function(){},l=void 0,r=void 0,t=void 0,u=function(){m=g.value;s=l.value;e=r.value;$.post("https://api.elasticemail.com/v2/email/send",{apikey:"ba451acf-e504-4c5a-9aea-8b0401d1ec93",
bodyText:m,to:e,from:"o.vargas.bobg@gmail.com"})},v=function(){(void 0).hide();t.text("Send").unbind("click").on("click",u)};$(function(){a||(a=!0,h=$("messageMarquee"),insertOptions=$("#messageOptions"),imageInsertOptionsClose=$("#messageOptionsClose"),r=$("#form-email"),l=$("#form-subject"),g=$("#form-message"),$("#attachment"),t=$("#email-send"),messageOptionsClose.on("click",v),v())});return{name:"message",activate:function(){f.currentMode.deactivate();f.currentMode=f.message;c("#messageTools",
"#messageMode");v();D.call("onLayoutUpdated");S(B,k,k,function(a,b,c,d){h.show();h.css({left:G(a),top:G(b)});O(d.x,d.y)})},deactivate:function(){v();Q(B);b()}}}}}(U);return U};
